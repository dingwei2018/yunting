# 北京云听音频精修系统 - 服务模块架构设计

## 一、架构概述

### 1.1 技术栈
- **后端框架**: Spring Boot
- **ORM框架**: MyBatis
- **消息队列**: RocketMQ
- **数据库**: MySQL
- **对象存储**: 华为云OBS（Object Storage Service）
- **第三方服务**: 华为云MetaStudio TTS服务（WebSocket接口）
- **音频处理**: FFmpeg

### 1.2 架构模式
- **分层架构**: Controller层、Service层、Mapper层
- **异步处理**: 语音合成、音频合并等耗时操作通过RocketMQ异步处理
- **外部集成**: 通过WebSocket客户端连接华为云MetaStudio服务

---

## 二、核心服务模块

### 2.1 任务管理服务模块 (TaskService)

**职责**:
- 创建任务并自动拆句
- 查询任务详情
- 查询任务列表（分页、筛选）
- 更新任务状态
- 管理任务的SSML配置

**主要功能**:
1. **创建任务** (`POST /tasks`)
   - 接收文本内容（最多10000字）
   - 调用拆句服务进行自动拆句
   - 创建任务记录和句子记录
   - 初始化默认合成参数

2. **查询任务详情** (`GET /tasks/taskid={task_id}`)
   - 查询任务基本信息
   - 关联查询所有句子
   - 返回任务的SSML配置
   - 返回合并音频信息

3. **查询任务列表** (`GET /tasks?page=1&page_size=20&status=2`)
   - 支持分页查询
   - 支持按状态筛选
   - 支持按时间排序

**依赖模块**:
- SentenceService（拆句）
- SSMLService（SSML生成）

---

### 2.2 断句管理服务模块 (BreakingSentenceService)

**职责**:
- 断句CRUD操作
- 断句列表查询
- 断句序列管理
- 断句内容编辑

**主要功能**:
1. **获取断句列表** (`GET /tasks/breaking-sentences?taskid={task_id}`)
   - 查询指定任务下的所有断句
   - 支持分页
   - 返回断句的合成状态、音频信息
   - 关联查询原始拆句信息

2. **获取断句详情** (`GET /breaking-sentences/info?breaking_sentence_id={breaking_sentence_id}`)
   - 查询断句完整信息
   - 关联查询合成设置、停顿设置、多音字设置
   - 返回断句的SSML配置
   - 关联查询原始拆句信息

3. **删除断句** (`DELETE /breaking-sentences?breaking_sentence_id={breaking_sentence_id}`)
   - 删除断句记录
   - 级联删除相关设置（停顿、多音字、合成设置）
   - 重新排序后续断句的sequence
   - 删除关联的音频文件

**依赖模块**:
- SynthesisSettingsService
- PauseSettingsService
- PolyphonicSettingsService
- AudioStorageService（删除音频文件）
- OriginalSentenceService（查询原始拆句信息）

---

### 2.3 原始拆句服务模块 (OriginalSentenceService)

**职责**:
- 原始拆句的CRUD操作
- 原始拆句查询

**主要功能**:
1. **创建原始拆句**（创建任务时）
   - 根据标点符号进行拆句（。！？；等）
   - 将拆句结果存储到原始拆句表（original_sentences）
   - 计算每个句子的字符数
   - 生成句子序列号

2. **查询原始拆句**
   - 查询任务下的所有原始拆句
   - 用于历史记录和断句生成

**技术实现**:
- 使用正则表达式进行文本拆分
- 根据标点符号（。！？；等）进行拆句

---

### 2.4 文本拆句服务模块 (SentenceBreakingService)

**职责**:
- 根据断句标准生成断句表
- 拆句规则管理
- 拆句标准查询

**主要功能**:
1. **生成断句表**（创建任务时或设置断句标准时）
   - 根据任务的断句标准生成断句表
   - **大符号断句**（ID=1）：
     - 将原始拆句表的内容复制到断句表
     - 每个原始拆句对应一个断句
   - **N个字符断句**（ID=2）：
     - 根据指定的字符数（char_count）重新拆分原始拆句
     - 一个原始拆句可能被拆分成多个断句
     - 每个断句的original_sentence_id都指向对应的原始拆句

2. **重新生成断句表**（设置断句标准时）
   - 清空原有的断句表数据
   - 根据新的断句标准重新生成断句表
   - 原有的断句参数设置会丢失

3. **获取断句标准** (`GET /sentence-breaking/standards`)
   - 返回系统支持的断句标准
   - 返回断句规则说明

4. **保存断句标准设置并重新生成断句** (`POST /sentence-breaking/settings?taskid={task_id}`)
   - 保存任务的断句标准设置
   - 立即重新生成断句表

**技术实现**:
- 使用正则表达式进行文本拆分
- 支持标点符号断句和N个字符断句
- 处理原始拆句和断句的关联关系（original_sentence_id）

---

### 2.4 语音合成服务模块 (SynthesisService)

**职责**:
- 调用华为云MetaStudio TTS服务
- 管理合成任务状态
- 处理合成结果回调
- SSML到华为云格式转换

**主要功能**:
1. **单个句子合成** (`POST /sentences/synthesize?sentenceid={sentence_id}`)
   - 构建SSML请求
   - 建立WebSocket连接
   - 发送合成请求到华为云
   - 接收音频数据流
   - 保存音频文件
   - 更新断句合成状态

2. **重新合成断句** (`POST /breaking-sentences/resynthesize?breaking_sentence_id={breaking_sentence_id}`)
   - 使用当前参数重新合成
   - 覆盖原有音频文件

3. **批量合成** (`POST /tasks/synthesize?taskid={task_id}`)
   - 发送批量合成消息到RocketMQ
   - 异步处理多个断句的合成
   - 支持指定断句ID列表

4. **查询合成状态** (`GET /synthesis/tasks?taskid={task_id}`)
   - 查询合成任务进度
   - 返回合成结果

**技术实现**:
- **WebSocket客户端**: 连接华为云MetaStudio服务
  - URL: `wss://metastudio-api.{region}.myhuaweicloud.com:443/v1/{project_id}/ttsc/jobs`
  - 认证: X-Auth-Token header
  - 音色绑定: X-Voice-Asset-Id header
- **消息队列**: RocketMQ处理异步合成任务
- **SSML转换**: 将系统SSML转换为华为云SSML格式

**依赖模块**:
- HuaweiCloudTTSClient（WebSocket客户端）
- RocketMQProducer（发送消息）
- AudioStorageService（保存音频）
- SSMLService（SSML生成和转换）

---

### 2.5 参数调整服务模块 (ParameterAdjustmentService)

**职责**:
- 调整句子合成参数
- 管理停顿和静音设置
- 管理多音字设置
- 应用阅读规范
- 自动更新SSML

**主要功能**:
1. **调整参数** (`POST /sentences/settings?sentenceid={sentence_id}`)
   - 更新合成参数（语速、音量、音调、音色）
   - 编辑句子内容
   - 添加/删除/修改停顿设置
   - 添加/删除/修改多音字设置
   - 应用阅读规范
   - **向下插入句子**（通过insert_sentences参数）
     - 在指定句子下方插入新句子
     - 插入的句子parent_id为指定的parent_id
     - 自动调整后续句子的sequence
   - **重新断句**（通过rebreak_sentence参数）
     - 根据断句标准重新断句
     - 如果断句标准是"大符号"：不执行重新断句
     - 如果断句标准是"N个字符"：将原句子拆成新的一组句子
     - 新生成的句子parent_id为原句子的ID
   - 自动重新生成SSML

2. **合成设置管理**
   - 创建/更新合成设置记录
   - 查询合成设置

3. **停顿设置管理**
   - 创建/更新/删除停顿设置
   - 支持停顿和静音两种类型

4. **多音字设置管理**
   - 创建/更新/删除多音字设置
   - 记录字符位置和读音

**依赖模块**:
- SynthesisSettingsService
- PauseSettingsService
- PolyphonicSettingsService
- ReadingRuleService（应用阅读规范）
- SentenceBreakingService（重新断句）
- SentenceService（插入句子、管理句子层级）
- SSMLService（更新SSML）

---

### 2.6 阅读规范服务模块 (ReadingRuleService)

**职责**:
- 创建和管理阅读规范
- 应用阅读规范到句子
- 查询阅读规范列表

**主要功能**:
1. **创建阅读规范** (`POST /reading-rules`)
   - 支持全局规范和任务规范
   - 存储匹配模式、规则类型、规则值

2. **获取阅读规范列表** (`GET /reading-rules?task_id=1&scope=2`)
   - 支持按任务ID查询
   - 支持按作用域筛选（全局/任务）

3. **应用阅读规范** (`POST /reading-rules/apply?ruleid={rule_id}&taskid={task_id}`)
   - 在指定任务的所有断句中匹配模式
   - 应用规则值替换
   - 记录应用到哪些断句（reading_rule_applications表）
   - 更新断句的SSML配置

**技术实现**:
- 使用正则表达式匹配模式
- 支持数字读法、日期读法、多音字等规则类型

**依赖模块**:
- BreakingSentenceService（查询任务下的断句）
- SSMLService（更新SSML）

---

### 2.7 音频编辑服务模块 (AudioEditingService)

**职责**:
- 音频合并
- 合并状态管理
- 音频文件管理

**主要功能**:
1. **合并音频** (`POST /tasks/audio/merge?taskid={task_id}`)
   - 获取指定断句的音频文件列表
   - 按sequence排序
   - 调用FFmpeg进行音频合并
   - 保存合并后的音频文件
   - 更新任务的merged_audio_url和merged_audio_duration
   - 记录合并操作（audio_merges表）

2. **查询合并状态** (`GET /audio/merges/merge?mergeid={merge_id}`)
   - 查询合并任务状态
   - 返回合并结果

**技术实现**:
- **FFmpeg命令**: 
  ```bash
  ffmpeg -i input1.mp3 -i input2.mp3 -filter_complex "[0:0][1:0]concat=n=2:v=0:a=1[out]" -map "[out]" output.mp3
  ```
- **异步处理**: 通过RocketMQ异步处理合并任务
- **音频格式**: 支持MP3、WAV等格式

**依赖模块**:
- FFmpegService（音频处理）
- RocketMQProducer（发送消息）
- AudioStorageService（保存音频）
- TaskService（更新任务信息）

---

### 2.8 音色管理服务模块 (VoiceService)

**职责**:
- 查询音色列表
- 管理音色配置
- 同步华为云音色信息

**主要功能**:
1. **获取音色列表** (`GET /voices?is_recommended=1&language=zh-CN`)
   - 查询数据库中的音色配置
   - 支持按推荐状态筛选
   - 支持按语言筛选
   - 支持排序

2. **音色配置管理**
   - 初始化常用音色到数据库
   - 支持从华为云同步音色列表
   - 管理推荐音色标记

**依赖模块**:
- HuaweiCloudTTSClient（查询音色列表）

---

### 2.9 SSML服务模块 (SSMLService)

**职责**:
- 生成SSML配置
- 更新SSML配置
- SSML格式转换（系统格式 ↔ 华为云格式）

**主要功能**:
1. **生成句子SSML**
   - 根据合成参数生成SSML
   - 包含音色、语速、音量、音调
   - 包含停顿标签（break）
   - 包含多音字标签（phoneme）

2. **生成任务SSML**
   - 合并所有句子的SSML
   - 生成整个任务的SSML配置

3. **SSML格式转换**
   - 系统SSML格式 → 华为云SSML格式
   - 处理华为云特定的SSML标签和属性

4. **SSML更新**
   - 参数调整后自动更新SSML
   - 应用阅读规范后更新SSML
   - 插入/删除句子后更新任务SSML

**技术实现**:
- 使用XML构建工具（如Java DOM或StringBuilder）
- 参考华为云SSML文档格式

**依赖模块**:
- SynthesisSettingsService
- PauseSettingsService
- PolyphonicSettingsService

---

### 2.10 华为云TTS客户端模块 (HuaweiCloudTTSClient)

**职责**:
- 管理WebSocket连接
- 发送TTS请求
- 接收音频数据流
- 处理错误和异常

**主要功能**:
1. **WebSocket连接管理**
   - 建立和维护WebSocket连接
   - 处理连接断开和重连
   - 管理连接池（如需要）

2. **发送合成请求**
   - 构建请求消息（command: START）
   - 发送SSML文本
   - 处理音色绑定（X-Voice-Asset-Id）

3. **接收音频数据**
   - 监听WebSocket消息
   - 解析音频数据（base64编码）
   - 处理流式数据接收
   - 识别合成结束标志（is_end: true）

4. **错误处理**
   - 处理认证失败（401）
   - 处理合成错误（500）
   - 处理网络异常

**技术实现**:
- 使用Java WebSocket客户端（如OkHttp WebSocket或Java-WebSocket）
- 支持异步回调
- 实现重连机制

**配置信息**:
- Region: cn-north-4（华北-北京四）或 cn-east-3（华东-上海一）
- Project ID: 从配置读取
- Token: 从认证服务获取

**依赖模块**:
- AuthenticationService（获取Token）

---

### 2.11 音频存储服务模块 (AudioStorageService)

**职责**:
- 保存音频文件到华为云OSS
- 删除音频文件
- 生成音频URL
- 计算音频时长

**主要功能**:
1. **保存音频文件**
   - 接收音频数据（字节流或base64）
   - 上传到华为云OSS
   - 生成唯一文件名（如：`audio/{task_id}/{sentence_id}_{timestamp}.mp3`）
   - 返回OSS访问URL

2. **删除音频文件**
   - 从华为云OSS删除指定音频文件
   - 清理存储空间

3. **生成音频URL**
   - 生成华为云OSS的访问URL
   - 支持CDN加速（如配置了CDN）
   - 支持临时访问URL（如需要）

4. **计算音频时长**
   - 使用FFmpeg或音频库计算时长
   - 返回毫秒数

**技术实现**:
- **对象存储**: 华为云OBS（Object Storage Service）
  - 使用华为云OBS Java SDK
  - 支持流式上传
  - 支持断点续传（如需要）
- **音频处理**: 使用FFmpeg或Java音频库（如JAudioTagger）

**配置信息**:
- OBS Endpoint: 从配置读取（如：`obs.cn-north-4.myhuaweicloud.com`）
- Access Key ID: 从配置读取
- Secret Access Key: 从配置读取
- Bucket Name: 从配置读取
- 存储路径前缀: 从配置读取（如：`audio/`）

**依赖模块**:
- FFmpegService（计算时长）
- HuaweiCloudOBSService（华为云OSS客户端）

---

### 2.12 FFmpeg服务模块 (FFmpegService)

**职责**:
- 执行FFmpeg命令
- 音频合并
- 音频格式转换
- 音频时长计算

**主要功能**:
1. **音频合并**
   - 执行FFmpeg合并命令
   - 处理多个音频文件
   - 支持不同格式的音频

2. **音频处理**
   - 格式转换
   - 采样率调整
   - 音量调整（如需要）

3. **音频信息提取**
   - 提取音频时长
   - 提取音频格式信息

**技术实现**:
- 使用Java ProcessBuilder执行FFmpeg命令
- 处理命令执行结果和错误
- 支持异步执行

---

### 2.13 消息队列服务模块 (RocketMQService)

**职责**:
- 发送异步任务消息
- 消费异步任务消息
- 管理消息队列

**主要功能**:
1. **发送消息**
   - 批量合成任务
   - 音频合并任务
   - 其他异步任务

2. **消费消息**
   - 批量合成消费者
   - 音频合并消费者
   - 处理任务失败和重试

**消息主题**:
- `synthesis_batch`: 批量合成任务
- `audio_merge`: 音频合并任务

**依赖模块**:
- SynthesisService（消费合成消息）
- AudioEditingService（消费合并消息）

---

### 2.14 认证服务模块 (AuthenticationService)

**职责**:
- 获取华为云Token
- Token缓存和管理
- Token刷新

**主要功能**:
1. **获取Token**
   - 调用华为云IAM服务获取Token
   - 缓存Token（避免频繁请求）
   - Token过期自动刷新

2. **Token管理**
   - Token有效期管理
   - Token刷新机制

**技术实现**:
- 调用华为云IAM API获取Token
- 使用Redis或内存缓存Token
- 实现Token自动刷新

---

### 2.15 华为云OSS客户端模块 (HuaweiCloudOBSService)

**职责**:
- 管理华为云OBS连接
- 上传音频文件
- 删除音频文件
- 生成访问URL

**主要功能**:
1. **上传文件**
   - 上传音频文件到OBS
   - 支持流式上传
   - 支持断点续传（如需要）
   - 生成唯一对象键（Object Key）

2. **删除文件**
   - 从OBS删除指定文件
   - 批量删除（如需要）

3. **生成访问URL**
   - 生成OBS访问URL
   - 支持临时URL（如需要）
   - 支持CDN加速URL（如配置了CDN）

4. **文件管理**
   - 检查文件是否存在
   - 获取文件元数据
   - 列出文件列表（如需要）

**技术实现**:
- 使用华为云OBS Java SDK
- 支持异步上传
- 实现重试机制

**配置信息**:
- OBS Endpoint: 从配置读取（如：`obs.cn-north-4.myhuaweicloud.com`）
- Access Key ID: 从配置读取
- Secret Access Key: 从配置读取
- Bucket Name: 从配置读取
- 存储路径前缀: 从配置读取（如：`audio/`）

**依赖模块**:
- 无（独立服务）

---

## 三、数据访问层模块

### 3.1 Mapper层（MyBatis）

**职责**: 数据库操作

**主要Mapper**:
1. **TaskMapper**: 任务表操作
2. **OriginalSentenceMapper**: 原始拆句表操作
3. **BreakingSentenceMapper**: 断句表操作
4. **SynthesisSettingsMapper**: 合成设置表操作
5. **PauseSettingsMapper**: 停顿设置表操作
6. **PolyphonicSettingsMapper**: 多音字设置表操作
7. **ReadingRuleMapper**: 阅读规范表操作
8. **ReadingRuleApplicationMapper**: 阅读规范应用表操作
9. **AudioMergeMapper**: 音频合并记录表操作
10. **VoiceConfigMapper**: 音色配置表操作

---

## 四、Controller层模块

### 4.1 REST API控制器

**职责**: 处理HTTP请求，调用Service层

**主要Controller**:
1. **TaskController**: 任务管理接口
2. **BreakingSentenceController**: 断句管理接口
3. **SynthesisController**: 语音合成接口
4. **ParameterController**: 参数调整接口（批量设置和单个设置）
5. **ReadingRuleController**: 阅读规范接口
6. **AudioEditingController**: 音频编辑接口
7. **VoiceController**: 音色管理接口
8. **SentenceBreakingController**: 断句标准接口（查询和保存设置并重新生成断句）

---

## 五、配置和工具模块

### 5.1 配置模块

**职责**: 管理系统配置

**主要配置**:
- 华为云MetaStudio配置（Region、Project ID、认证信息）
- 华为云OBS配置（Endpoint、Access Key ID、Secret Access Key、Bucket Name、存储路径前缀）
- 数据库配置
- RocketMQ配置
- FFmpeg路径配置
- 文件上传大小限制

### 5.2 工具类模块

**职责**: 提供通用工具方法

**主要工具类**:
- **ResponseUtil**: 统一响应格式封装
- **ExceptionHandler**: 全局异常处理
- **ValidationUtil**: 参数校验工具
- **DateUtil**: 日期时间工具
- **FileUtil**: 文件操作工具
- **SSMLUtil**: SSML处理工具

---

## 六、模块依赖关系图

```
Controller层
    ↓
Service层
    ├── TaskService
    │   ├── SentenceService
    │   └── SSMLService
    ├── SentenceService
    │   ├── SynthesisSettingsService
    │   ├── PauseSettingsService
    │   ├── PolyphonicSettingsService
    │   ├── HuaweiCloudOBSService
    │   └── AudioStorageService
    ├── SynthesisService
    │   ├── HuaweiCloudTTSClient
    │   ├── SSMLService
    │   ├── AudioStorageService
    │   └── RocketMQService
    ├── ParameterAdjustmentService
    │   ├── SynthesisSettingsService
    │   ├── PauseSettingsService
    │   ├── PolyphonicSettingsService
    │   ├── ReadingRuleService
    │   ├── BreakingSentenceService
    │   └── SSMLService
    ├── ReadingRuleService
    │   ├── BreakingSentenceService
    │   └── SSMLService
    ├── SentenceBreakingService
    │   └── OriginalSentenceService
    ├── OriginalSentenceService
    ├── AudioEditingService
    │   ├── FFmpegService
    │   ├── AudioStorageService
    │   ├── RocketMQService
    │   └── TaskService
    ├── VoiceService
    │   └── HuaweiCloudTTSClient
    ├── HuaweiCloudTTSClient
    │   └── AuthenticationService
    ├── AudioStorageService
    │   ├── HuaweiCloudOBSService（华为云OSS客户端）
    │   └── FFmpegService
    └── RocketMQService
        ├── SynthesisService (消费者)
        └── AudioEditingService (消费者)
    ↓
Mapper层 (MyBatis)
    ↓
数据库 (MySQL)
```

---

## 七、异步处理流程

### 7.1 批量合成流程

```
1. 用户请求批量合成
   ↓
2. Controller接收请求
   ↓
3. SynthesisService发送消息到RocketMQ
   ↓
4. 返回task_id给用户
   ↓
5. RocketMQ消费者接收消息
   ↓
6. 循环处理每个句子：
   a. 构建SSML
   b. 调用HuaweiCloudTTSClient
   c. 接收音频数据
   d. 保存音频文件
   e. 更新句子状态
   ↓
7. 所有句子合成完成后，更新任务状态
```

### 7.2 音频合并流程

```
1. 用户请求合并音频
   ↓
2. Controller接收请求
   ↓
3. AudioEditingService发送消息到RocketMQ
   ↓
4. 返回merge_id给用户
   ↓
5. RocketMQ消费者接收消息
   ↓
6. 获取所有句子的音频文件
   ↓
7. 调用FFmpegService合并音频
   ↓
8. 保存合并后的音频文件
   ↓
9. 更新任务的merged_audio_url和merged_audio_duration
   ↓
10. 更新合并记录状态
```

---

## 八、关键技术点

### 8.1 华为云MetaStudio集成

1. **WebSocket连接**
   - 使用WebSocket客户端库
   - 实现连接池管理（如需要）
   - 处理连接断开和重连

2. **SSML格式**
   - 参考华为云SSML文档
   - 实现格式转换
   - 支持华为云特定的标签和属性

3. **认证**
   - 获取和刷新Token
   - Token缓存机制

### 8.2 异步处理

1. **RocketMQ**
   - 消息发送和消费
   - 消息重试机制
   - 消息幂等性处理

2. **状态管理**
   - 任务状态更新
   - 合成状态更新
   - 合并状态更新

### 8.3 音频处理

1. **FFmpeg集成**
   - 命令执行
   - 错误处理
   - 进度监控（如需要）

2. **音频存储（华为云OBS）**
   - 使用华为云OBS存储音频文件
   - OBS URL生成
   - 文件上传和删除
   - 支持CDN加速

---

## 九、开发优先级建议

### 第一阶段：基础功能
1. 任务管理服务（创建、查询）
2. 原始拆句服务（创建、查询）
3. 断句生成服务（生成断句表）
4. 断句管理服务（查询、删除）
5. 数据访问层（Mapper）

### 第二阶段：核心功能
1. SSML服务
2. 华为云TTS客户端
3. 语音合成服务（单个合成）
4. 参数调整服务
5. 音频存储服务

### 第三阶段：高级功能
1. 批量合成（RocketMQ）
2. 音频合并（FFmpeg）
3. 阅读规范服务
4. 音色管理服务

### 第四阶段：优化和完善
1. 异常处理和重试机制
2. 性能优化
3. 日志和监控
4. 单元测试和集成测试

---

## 十、总结

### 10.1 核心服务模块（15个）
1. TaskService - 任务管理
2. SentenceService - 句子管理
3. SentenceBreakingService - 文本拆句
4. SynthesisService - 语音合成
5. ParameterAdjustmentService - 参数调整
6. ReadingRuleService - 阅读规范
7. AudioEditingService - 音频编辑
8. VoiceService - 音色管理
9. SSMLService - SSML处理
10. HuaweiCloudTTSClient - 华为云TTS客户端
11. AudioStorageService - 音频存储（华为云OBS）
12. HuaweiCloudOBSService - 华为云OSS客户端
13. FFmpegService - FFmpeg处理
14. RocketMQService - 消息队列
15. AuthenticationService - 认证服务

### 10.2 数据访问层
- 10个Mapper对应10个数据库表

### 10.3 Controller层
- 8个Controller对应8类接口

### 10.4 配置和工具
- 配置管理
- 工具类

---

---

## 十一、数据结构说明（v2.0）

### 11.1 核心设计理念

1. **原始拆句和断句分离**
   - `original_sentences` 表存储最初拆句的结果（根据标点符号）
   - `breaking_sentences` 表存储实际用于合成的断句
   - 原始拆句数据不会改变，用于历史记录

2. **每个断句独立管理参数**
   - 每个断句有独立的合成设置（synthesis_settings）
   - 每个断句有独立的停顿设置（pause_settings）
   - 每个断句有独立的多音字设置（polyphonic_settings）
   - 每个断句可以应用多个阅读规范（reading_rule_applications）

3. **结构简单明确**
   - 不需要复杂的parent_id层级关系
   - 原始拆句和断句通过original_sentence_id关联
   - 参数设置直接关联到断句ID

### 11.2 断句标准逻辑

1. **大符号断句**（ID=1）
   - 将原始拆句表的内容复制到断句表
   - 每个原始拆句对应一个断句
   - `breaking_sentences.original_sentence_id` 关联到对应的原始拆句

2. **N个字符断句**（ID=2）
   - 根据指定的字符数（char_count）重新拆分原始拆句
   - 一个原始拆句可能被拆分成多个断句
   - 每个断句的 `original_sentence_id` 都指向同一个原始拆句

### 11.3 数据流转

- **向下插入句子**和**重新断句**都在前端点击保存设置时，通过参数设置接口一并提交到后端
- 断句标准接口仅用于保存设置，不执行断句操作
- 断句操作在参数设置接口中，通过`rebreak_sentence`参数触发

---

**文档版本**: v1.1  
**最后更新**: 2024年


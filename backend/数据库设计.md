# 北京云听音频精修系统 - 数据库设计

## 一、数据库概述

### 1.1 数据库信息
- **数据库类型**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 1.2 设计原则
- 原始拆句和实际使用的断句分离
- 每个断句独立管理参数
- 结构简单明确，易于维护

---

## 二、核心表设计

### 2.1 任务表 (tasks)

**表名**: `tasks`

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| task_id | BIGINT | 任务ID | PRIMARY KEY, AUTO_INCREMENT |
| content | TEXT | 原始文本内容（最多10000字） | NOT NULL |
| char_count | INT | 字符数 | NOT NULL |
| status | TINYINT | 任务状态（1-待拆句，2-已拆句，3-已完成） | NOT NULL, DEFAULT 1 |
| merged_audio_url | VARCHAR(500) | 合并音频URL | NULL |
| merged_audio_duration | INT | 合并音频时长（毫秒） | NULL |
| breaking_standard_id | INT | 断句标准ID（1-大符号，2-N个字符） | NULL |
| char_count_limit | INT | 字符数限制（当断句标准为N个字符时使用） | NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (task_id)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)

---

### 2.2 原始拆句表 (original_sentences)

**表名**: `original_sentences`

**说明**: 存储最初拆句的结果（根据标点符号拆句）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| original_sentence_id | BIGINT | 原始句子ID | PRIMARY KEY, AUTO_INCREMENT |
| task_id | BIGINT | 任务ID | NOT NULL, FOREIGN KEY |
| content | TEXT | 句子内容 | NOT NULL |
| char_count | INT | 字符数 | NOT NULL |
| sequence | INT | 序列号 | NOT NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |

**索引**:
- PRIMARY KEY (original_sentence_id)
- INDEX idx_task_id (task_id)
- INDEX idx_sequence (task_id, sequence)

**表关系**:
- 一个任务有多个原始拆句（一对多）

---

### 2.3 断句表 (breaking_sentences)

**表名**: `breaking_sentences`

**说明**: 存储实际用于合成的断句
- 如果断句标准是"大符号"：复制原始拆句内容到断句表
- 如果断句标准是"N个字符"：重新拆分原始拆句，生成多个断句记录

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| breaking_sentence_id | BIGINT | 断句ID | PRIMARY KEY, AUTO_INCREMENT |
| task_id | BIGINT | 任务ID | NOT NULL, FOREIGN KEY |
| original_sentence_id | BIGINT | 原始句子ID（关联到original_sentences表） | NULL, FOREIGN KEY |
| content | TEXT | 断句内容 | NOT NULL |
| char_count | INT | 字符数 | NOT NULL |
| sequence | INT | 序列号 | NOT NULL |
| synthesis_status | TINYINT | 合成状态（0-未合成，1-合成中，2-已合成，3-合成失败） | NOT NULL, DEFAULT 0 |
| audio_url | VARCHAR(500) | 音频URL | NULL |
| audio_duration | INT | 音频时长（毫秒） | NULL |
| ssml | TEXT | SSML配置 | NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (breaking_sentence_id)
- INDEX idx_task_id (task_id)
- INDEX idx_original_sentence_id (original_sentence_id)
- INDEX idx_sequence (task_id, sequence)
- INDEX idx_synthesis_status (synthesis_status)

**表关系**:
- 一个任务有多个断句（一对多）
- 一个原始拆句可以对应多个断句（一对多，当N个字符断句时）

---

### 2.4 合成设置表 (synthesis_settings)

**表名**: `synthesis_settings`

**说明**: 存储每个断句的合成参数

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| setting_id | BIGINT | 设置ID | PRIMARY KEY, AUTO_INCREMENT |
| breaking_sentence_id | BIGINT | 断句ID | NOT NULL, FOREIGN KEY, UNIQUE |
| voice_id | VARCHAR(50) | 音色ID | NOT NULL |
| voice_name | VARCHAR(100) | 音色名称 | NULL |
| speech_rate | INT | 语速（-50到50，单位：%） | NOT NULL, DEFAULT 0 |
| volume | INT | 音量（-50到50，单位：dB） | NOT NULL, DEFAULT 0 |
| pitch | INT | 音调（-50到50，单位：%） | NOT NULL, DEFAULT 0 |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (setting_id)
- UNIQUE KEY uk_breaking_sentence_id (breaking_sentence_id)
- INDEX idx_voice_id (voice_id)

**表关系**:
- 一个断句对应一个合成设置（一对一）

---

### 2.5 停顿设置表 (pause_settings)

**表名**: `pause_settings`

**说明**: 存储断句中的停顿和静音设置

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| pause_id | BIGINT | 停顿ID | PRIMARY KEY, AUTO_INCREMENT |
| breaking_sentence_id | BIGINT | 断句ID | NOT NULL, FOREIGN KEY |
| position | INT | 位置（字符位置） | NOT NULL |
| duration | INT | 时长（毫秒） | NOT NULL |
| type | TINYINT | 类型（1-停顿，2-静音） | NOT NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |

**索引**:
- PRIMARY KEY (pause_id)
- INDEX idx_breaking_sentence_id (breaking_sentence_id)

**表关系**:
- 一个断句可以有多个停顿设置（一对多）

---

### 2.6 多音字设置表 (polyphonic_settings)

**表名**: `polyphonic_settings`

**说明**: 存储断句中的多音字设置

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| polyphonic_id | BIGINT | 多音字ID | PRIMARY KEY, AUTO_INCREMENT |
| breaking_sentence_id | BIGINT | 断句ID | NOT NULL, FOREIGN KEY |
| character | VARCHAR(10) | 字符 | NOT NULL |
| position | INT | 位置（字符位置） | NOT NULL |
| pronunciation | VARCHAR(50) | 读音（拼音） | NOT NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |

**索引**:
- PRIMARY KEY (polyphonic_id)
- INDEX idx_breaking_sentence_id (breaking_sentence_id)

**表关系**:
- 一个断句可以有多个多音字设置（一对多）

---

### 2.7 阅读规范表 (reading_rules)

**表名**: `reading_rules`

**说明**: 存储阅读规范（数字读法、日期读法等）

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| rule_id | BIGINT | 规范ID | PRIMARY KEY, AUTO_INCREMENT |
| task_id | BIGINT | 任务ID（scope=2时使用） | NULL, FOREIGN KEY |
| pattern | VARCHAR(200) | 匹配模式 | NOT NULL |
| rule_type | VARCHAR(50) | 规范类型（数字读法、日期读法等） | NOT NULL |
| rule_value | VARCHAR(200) | 规范值（替换后的内容） | NOT NULL |
| scope | TINYINT | 作用域（1-全局，2-任务） | NOT NULL |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (rule_id)
- INDEX idx_task_id (task_id)
- INDEX idx_scope (scope)

**表关系**:
- 一个任务可以有多个阅读规范（一对多，scope=2时）

---

### 2.8 阅读规范应用表 (reading_rule_applications)

**表名**: `reading_rule_applications`

**说明**: 记录阅读规范应用到哪些断句

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| application_id | BIGINT | 应用ID | PRIMARY KEY, AUTO_INCREMENT |
| rule_id | BIGINT | 规范ID | NOT NULL, FOREIGN KEY |
| breaking_sentence_id | BIGINT | 断句ID | NOT NULL, FOREIGN KEY |
| created_at | DATETIME | 创建时间 | NOT NULL |

**索引**:
- PRIMARY KEY (application_id)
- INDEX idx_rule_id (rule_id)
- INDEX idx_breaking_sentence_id (breaking_sentence_id)
- UNIQUE KEY uk_rule_breaking (rule_id, breaking_sentence_id)

**表关系**:
- 一个阅读规范可以应用到多个断句（一对多）
- 一个断句可以应用多个阅读规范（一对多）

---

### 2.9 音频合并记录表 (audio_merges)

**表名**: `audio_merges`

**说明**: 记录音频合并操作

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| merge_id | BIGINT | 合并ID | PRIMARY KEY, AUTO_INCREMENT |
| task_id | BIGINT | 任务ID | NOT NULL, FOREIGN KEY |
| breaking_sentence_ids | TEXT | 断句ID列表（JSON格式） | NOT NULL |
| merged_audio_url | VARCHAR(500) | 合并音频URL | NULL |
| audio_duration | INT | 合并音频时长（毫秒） | NULL |
| status | TINYINT | 状态（1-处理中，2-已完成，3-失败） | NOT NULL, DEFAULT 1 |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (merge_id)
- INDEX idx_task_id (task_id)
- INDEX idx_status (status)

**表关系**:
- 一个任务可以有多个合并记录（一对多）

---

### 2.10 音色配置表 (voice_configs)

**表名**: `voice_configs`

**说明**: 存储系统支持的音色配置

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| voice_id | VARCHAR(50) | 音色ID | PRIMARY KEY |
| voice_name | VARCHAR(100) | 音色名称 | NOT NULL |
| voice_type | VARCHAR(20) | 音色类型（男声、女声等） | NOT NULL |
| language | VARCHAR(10) | 语言（zh-CN等） | NOT NULL |
| is_recommended | TINYINT | 是否推荐（1-是，0-否） | NOT NULL, DEFAULT 0 |
| sort_order | INT | 排序顺序 | NOT NULL, DEFAULT 0 |
| created_at | DATETIME | 创建时间 | NOT NULL |
| updated_at | DATETIME | 更新时间 | NOT NULL |

**索引**:
- PRIMARY KEY (voice_id)
- INDEX idx_is_recommended (is_recommended)
- INDEX idx_language (language)

---

## 三、表关系图

```
tasks (任务表)
  ├── original_sentences (原始拆句表) [一对多]
  │     └── breaking_sentences (断句表) [一对多]
  │           ├── synthesis_settings (合成设置表) [一对一]
  │           ├── pause_settings (停顿设置表) [一对多]
  │           ├── polyphonic_settings (多音字设置表) [一对多]
  │           └── reading_rule_applications (阅读规范应用表) [多对多]
  ├── reading_rules (阅读规范表) [一对多，scope=2时]
  └── audio_merges (音频合并记录表) [一对多]

voice_configs (音色配置表) [独立表]
```

---

## 四、数据库设计说明

### 4.1 核心设计理念

1. **原始拆句和断句分离**
   - `original_sentences` 表存储最初拆句的结果（根据标点符号）
   - `breaking_sentences` 表存储实际用于合成的断句
   - 如果断句标准是"大符号"：复制原始拆句内容到断句表
   - 如果断句标准是"N个字符"：重新拆分原始拆句，生成多个断句记录

2. **每个断句独立管理参数**
   - 每个断句有独立的合成设置（synthesis_settings）
   - 每个断句有独立的停顿设置（pause_settings）
   - 每个断句有独立的多音字设置（polyphonic_settings）
   - 每个断句可以应用多个阅读规范（reading_rule_applications）

3. **结构简单明确**
   - 不需要复杂的parent_id层级关系
   - 原始拆句和断句通过original_sentence_id关联
   - 参数设置直接关联到断句ID

### 4.2 断句逻辑说明

#### 4.2.1 创建任务时
1. 接收文本内容
2. 根据标点符号（。！？；等）进行拆句
3. 将拆句结果存储到 `original_sentences` 表
4. 根据任务的断句标准（默认大符号），将原始拆句复制到 `breaking_sentences` 表

#### 4.2.2 大符号断句模式
1. 如果断句标准是"大符号"（ID=1）
2. 将 `original_sentences` 表中的内容复制到 `breaking_sentences` 表
3. 每个原始拆句对应一个断句
4. `breaking_sentences.original_sentence_id` 关联到对应的原始拆句

#### 4.2.3 N个字符断句模式
1. 如果断句标准是"N个字符"（ID=2）
2. 根据指定的字符数（char_count_limit）重新拆分原始拆句
3. 一个原始拆句可能被拆分成多个断句
4. 每个断句的 `original_sentence_id` 都指向同一个原始拆句
5. 新生成的断句按照sequence排序

### 4.3 参数设置说明

1. **参数设置接口传入断句ID**
   - 接口参数：`breaking_sentence_id`（断句ID）
   - 接口参数：`content`（断句内容，可选）
   - 接口参数：合成参数（voice_id、speech_rate、volume、pitch等）
   - 接口参数：停顿设置（pauses）
   - 接口参数：多音字设置（polyphonic）
   - 接口参数：阅读规范ID列表（reading_rule_ids）

2. **参数存储**
   - 合成参数存储到 `synthesis_settings` 表
   - 停顿设置存储到 `pause_settings` 表
   - 多音字设置存储到 `polyphonic_settings` 表
   - 阅读规范应用存储到 `reading_rule_applications` 表

3. **参数更新**
   - 如果传入断句ID，更新对应断句的参数
   - 如果传入断句内容，更新断句的内容
   - 参数更新后，SSML自动重新生成

### 4.4 数据流转

1. **创建任务** → 原始拆句表 → 断句表（根据断句标准）
2. **设置断句标准** → 更新任务表的断句标准 → 重新生成断句表
3. **参数设置** → 更新断句的参数设置 → 更新SSML
4. **语音合成** → 更新断句表的合成状态和音频URL
5. **音频合并** → 合并断句的音频 → 更新任务表的合并音频URL

---

## 五、数据库初始化

### 5.1 初始化音色配置

```sql
INSERT INTO voice_configs (voice_id, voice_name, voice_type, language, is_recommended, sort_order) VALUES
('xiaoyan', '小燕', '女声', 'zh-CN', 1, 1),
('xiaoyun', '小云', '女声', 'zh-CN', 1, 2),
('xiaofeng', '小峰', '男声', 'zh-CN', 1, 3);
```

### 5.2 初始化断句标准

断句标准存储在任务表中，不需要单独的表。

---

**文档版本**: v2.0  
**创建时间**: 2024年  
**最后更新**: 2024年


# 云听后端服务 - Docker 部署说明

本文档说明如何将云听后端服务部署到 Ubuntu 24.04.3 服务器的 Docker 环境中。

## 前置要求

1. **操作系统**: Ubuntu 24.04.3
2. **Docker**: 版本 20.10 或更高
3. **Docker Compose**: 版本 2.0 或更高
4. **用户权限**: root 用户或具有 sudo 权限的用户

## 一、服务器环境准备

### 1.1 安装 Docker

```bash
# 更新系统包
apt update

# 安装必要的依赖
apt install -y ca-certificates curl gnupg lsb-release

# 添加 Docker 官方 GPG 密钥
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 添加 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker Engine
apt update
apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 启动 Docker 服务
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
docker compose version
```

### 1.2 验证 Docker 安装

```bash
# 测试 Docker 是否正常工作
docker run hello-world
```

## 二、项目文件准备

### 2.1 上传项目文件到服务器

将以下文件上传到服务器的项目目录（例如：`/root/yunting-backend`）：

```
/root/yunting-backend/
├── target/
│   └── backend-1.0.0.jar       # 已打包的 jar 文件
├── src/main/resources/db/      # 数据库初始化脚本目录
│   ├── schema.sql
│   └── init-data.sql
├── Dockerfile                   # Docker 镜像构建文件
├── docker-compose.yml          # Docker Compose 配置文件
└── .dockerignore               # Docker 构建忽略文件
```

### 2.2 上传方式

**方式一：使用 SCP 命令（从本地 Windows）**

```powershell
# 在本地 Windows PowerShell 中执行
scp -r target/backend-1.0.0.jar root@服务器IP:/root/yunting-backend/target/
scp Dockerfile root@服务器IP:/root/yunting-backend/
scp docker-compose.yml root@服务器IP:/root/yunting-backend/
scp .dockerignore root@服务器IP:/root/yunting-backend/
scp -r src/main/resources/db root@服务器IP:/root/yunting-backend/src/main/resources/
```

**方式二：使用 Git（如果项目在 Git 仓库中）**

```bash
# 在服务器上执行
cd /root
git clone <your-repo-url> yunting-backend
cd yunting-backend
# 确保 jar 文件已构建并存在于 target 目录
```

## 三、配置环境变量（可选）

### 3.1 创建环境变量文件

如果需要自定义配置，可以创建 `.env` 文件：

```bash
cd /root/yunting-backend
nano .env
```

在 `.env` 文件中添加或修改以下配置：

```env
# 华为云 SDK 配置
HUAWEICLOUD_SDK_AK=your-access-key
HUAWEICLOUD_SDK_SK=your-secret-key
HUAWEICLOUD_SDK_REGION=cn-north-4
HUAWEICLOUD_SDK_PROJECT_ID=your-project-id

# 华为云 OBS 配置
HUAWEICLOUD_OBS_ENDPOINT=https://obs.cn-north-4.myhuaweicloud.com
HUAWEICLOUD_OBS_BUCKET=your-bucket-name
HUAWEICLOUD_OBS_PREFIX=audio/

# 应用回调URL配置
APP_CALLBACK_URL=http://your-domain.com/api/synthesis/callback
```

**注意**: 如果不创建 `.env` 文件，将使用 `docker-compose.yml` 中的默认值。

## 四、构建和启动服务

### 4.1 构建 Docker 镜像

```bash
cd /root/yunting-backend
docker compose build
```

或者单独构建后端镜像：

```bash
docker build -t yunting-backend:latest .
```

### 4.2 启动所有服务

```bash
# 使用 Docker Compose 启动（推荐）
docker compose up -d

# 查看启动日志
docker compose logs -f
```

### 4.3 验证服务状态

```bash
# 查看容器状态
docker compose ps

# 检查后端服务健康状态
curl http://localhost:8080/api/health

# 查看后端服务日志
docker compose logs backend -f
```

## 五、常用操作命令

### 5.1 查看日志

```bash
# 查看所有服务日志
docker compose logs -f

# 查看后端服务日志
docker compose logs backend -f

# 查看 MySQL 服务日志
docker compose logs mysql -f

# 查看最近 100 行日志
docker compose logs --tail=100 backend
```

### 5.2 停止和启动服务

```bash
# 停止所有服务
docker compose stop

# 启动所有服务
docker compose start

# 重启所有服务
docker compose restart

# 停止并删除容器（保留数据卷）
docker compose down

# 停止并删除容器及数据卷（⚠️ 危险：会删除数据库数据）
docker compose down -v
```

### 5.3 更新应用

```bash
# 1. 上传新的 jar 文件到 target/ 目录
# 2. 重新构建镜像
docker compose build backend

# 3. 重启服务
docker compose up -d backend

# 或者使用以下命令一次性完成
docker compose up -d --build backend
```

### 5.4 进入容器

```bash
# 进入后端容器
docker compose exec backend sh

# 进入 MySQL 容器
docker compose exec mysql bash

# 连接到 MySQL 数据库
docker compose exec mysql mysql -uyunting -pyunting yunting
```

## 六、数据库管理

### 6.1 数据库初始化

首次启动时，Docker Compose 会自动执行 `src/main/resources/db/` 目录下的 SQL 脚本：
- `schema.sql` - 创建数据库和表结构
- `init-data.sql` - 初始化基础数据

### 6.2 备份数据库

```bash
# 创建数据库备份
docker compose exec mysql mysqldump -uyunting -pyunting yunting > backup_$(date +%Y%m%d_%H%M%S).sql

# 或者使用 root 用户
docker compose exec mysql mysqldump -uroot -psecret yunting > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 6.3 恢复数据库

```bash
# 恢复数据库备份
docker compose exec -T mysql mysql -uyunting -pyunting yunting < backup_20241127_120000.sql
```

## 七、防火墙配置

如果服务器启用了防火墙，需要开放以下端口：

```bash
# UFW（Ubuntu 默认防火墙）
ufw allow 8080/tcp
ufw allow 3306/tcp

# 或者使用 iptables
iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
```

**注意**: 生产环境建议只开放 8080 端口，MySQL 端口（3306）不需要对外暴露。

## 八、生产环境优化建议

### 8.1 修改 docker-compose.yml

生产环境建议：

1. **移除 MySQL 端口映射**（仅内部访问）：
   ```yaml
   # 删除或注释掉这一行
   # ports:
   #   - "3306:3306"
   ```

2. **使用环境变量文件**管理敏感配置：
   ```bash
   docker compose --env-file .env.production up -d
   ```

3. **配置资源限制**：
   ```yaml
   services:
     backend:
       deploy:
         resources:
           limits:
             cpus: '2'
             memory: 2G
           reservations:
             cpus: '1'
             memory: 1G
   ```

### 8.2 配置反向代理（可选）

使用 Nginx 作为反向代理：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 8.3 日志管理

日志文件存储在 Docker 数据卷中，可以通过以下方式查看：

```bash
# 查看日志卷
docker volume ls | grep backend_logs

# 查看日志文件（需要进入容器）
docker compose exec backend ls -lh /app/logs/
```

## 九、故障排查

### 9.1 服务无法启动

```bash
# 查看详细错误信息
docker compose logs backend

# 检查容器状态
docker compose ps

# 检查镜像是否存在
docker images | grep yunting
```

### 9.2 数据库连接失败

```bash
# 检查 MySQL 是否正常运行
docker compose ps mysql

# 检查 MySQL 日志
docker compose logs mysql

# 测试数据库连接
docker compose exec mysql mysql -uyunting -pyunting -e "SELECT 1"
```

### 9.3 端口被占用

```bash
# 检查端口占用情况
netstat -tulpn | grep 8080
netstat -tulpn | grep 3306

# 或者使用 ss 命令
ss -tulpn | grep 8080
```

### 9.4 内存不足

```bash
# 查看容器资源使用情况
docker stats

# 清理未使用的镜像和容器
docker system prune -a
```

## 十、健康检查和监控

### 10.1 健康检查接口

应用提供了健康检查接口：

```bash
curl http://localhost:8080/api/health
```

### 10.2 设置监控脚本

可以创建一个简单的监控脚本：

```bash
#!/bin/bash
# /root/yunting-backend/monitor.sh

if ! curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
    echo "$(date): 后端服务异常，正在重启..."
    docker compose restart backend
fi
```

添加到 crontab：

```bash
crontab -e
# 每 5 分钟检查一次
*/5 * * * * /root/yunting-backend/monitor.sh >> /root/yunting-backend/monitor.log 2>&1
```

## 十一、常见问题

### Q1: 容器启动后立即退出？

**A**: 检查 jar 文件是否存在且完整，查看容器日志：
```bash
docker compose logs backend
```

### Q2: 如何查看应用的实际配置？

**A**: 进入容器查看环境变量：
```bash
docker compose exec backend env | grep SPRING
```

### Q3: 如何修改 JVM 内存参数？

**A**: 修改 `docker-compose.yml` 中的 `JAVA_OPTS` 环境变量，或者修改 `Dockerfile` 中的默认值。

### Q4: 数据库数据会丢失吗？

**A**: 不会，数据存储在 Docker 数据卷中。只有执行 `docker compose down -v` 才会删除数据卷。

## 十二、完整部署检查清单

- [ ] Docker 和 Docker Compose 已安装
- [ ] jar 文件已上传到 `target/` 目录
- [ ] `Dockerfile` 和 `docker-compose.yml` 已上传
- [ ] 数据库初始化脚本已上传
- [ ] 环境变量已配置（如需要）
- [ ] 防火墙端口已开放
- [ ] 服务已成功启动
- [ ] 健康检查接口可访问
- [ ] 数据库连接正常

---

**部署完成后，访问**: `http://服务器IP:8080/api/health` 验证服务是否正常运行。

如有问题，请查看日志：`docker compose logs -f`


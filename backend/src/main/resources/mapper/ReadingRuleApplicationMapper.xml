<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunting.mapper.ReadingRuleApplicationMapper">

    <delete id="deleteByBreakingSentenceId" parameterType="long">
        DELETE FROM reading_rule_applications WHERE from_id = #{breakingSentenceId}
    </delete>

    <delete id="deleteByRuleId" parameterType="long">
        DELETE FROM reading_rule_applications WHERE rule_id = #{ruleId}
    </delete>

    <delete id="deleteByRuleIdAndTaskId">
        DELETE rra FROM reading_rule_applications rra
        WHERE rra.rule_id = #{ruleId} 
        AND (rra.from_id = #{taskId} OR EXISTS (
            SELECT 1 FROM breaking_sentences bs 
            WHERE bs.breaking_sentence_id = rra.from_id AND bs.task_id = #{taskId}
        ))
    </delete>

    <delete id="deleteByRuleIdAndFromIdAndType">
        DELETE FROM reading_rule_applications
        WHERE rule_id = #{ruleId}
        AND from_id = #{fromId}
        AND type = #{type}
    </delete>

    <insert id="insertBatch" parameterType="java.util.List">
        INSERT INTO reading_rule_applications (rule_id, from_id, type, is_open, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.ruleId}, #{item.fromId}, #{item.type}, 
             COALESCE(#{item.isOpen}, 1), NOW())
        </foreach>
    </insert>

    <insert id="insertOrUpdateBatch" parameterType="java.util.List">
        INSERT INTO reading_rule_applications (rule_id, from_id, type, is_open, created_at)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.ruleId}, #{item.fromId}, #{item.type}, 
             COALESCE(#{item.isOpen}, 1), NOW())
        </foreach>
        ON DUPLICATE KEY UPDATE
        is_open = VALUES(is_open),
        type = VALUES(type)
    </insert>

    <select id="selectRuleIdsByTaskId" resultType="long">
        SELECT DISTINCT rra.rule_id
        FROM reading_rule_applications rra
        <if test="taskId != null">
            WHERE (rra.from_id = #{taskId} OR EXISTS (
                SELECT 1 FROM breaking_sentences bs 
                WHERE bs.breaking_sentence_id = rra.from_id AND bs.task_id = #{taskId}
            )) AND rra.is_open = 1
        </if>
        <if test="taskId == null">
            WHERE rra.is_open = 1
        </if>
    </select>

    <update id="updateIsOpenByRuleIdAndTaskId">
        UPDATE reading_rule_applications rra
        SET rra.is_open = #{isOpen}
        WHERE rra.rule_id = #{ruleId} 
        AND (rra.from_id = #{taskId} OR EXISTS (
            SELECT 1 FROM breaking_sentences bs 
            WHERE bs.breaking_sentence_id = rra.from_id AND bs.task_id = #{taskId}
        ))
    </update>

    <select id="selectByRuleIdAndTaskId" resultType="com.yunting.model.ReadingRuleApplication">
        SELECT rra.*
        FROM reading_rule_applications rra
        WHERE rra.rule_id = #{ruleId} 
        AND (rra.from_id = #{taskId} OR EXISTS (
            SELECT 1 FROM breaking_sentences bs 
            WHERE bs.breaking_sentence_id = rra.from_id AND bs.task_id = #{taskId}
        ))
    </select>

    <select id="selectRuleIdsWithIsOpenByTaskId" resultType="map">
        SELECT rra.rule_id as rule_id, MAX(rra.is_open) as is_open
        FROM reading_rule_applications rra
        WHERE rra.from_id = #{taskId} OR EXISTS (
            SELECT 1 FROM breaking_sentences bs 
            WHERE bs.breaking_sentence_id = rra.from_id AND bs.task_id = #{taskId}
        )
        GROUP BY rra.rule_id
    </select>

    <select id="selectAllRuleIdsWithIsOpen" resultType="map">
        SELECT rule_id as rule_id, MAX(is_open) as is_open
        FROM reading_rule_applications
        GROUP BY rule_id
    </select>

    <select id="selectGlobalRulesWithTaskClosedRules" resultType="map">
        SELECT 
            r.rule_id,
            r.pattern,
            r.rule_type,
            r.rule_value,
            CASE WHEN rra_closed.rule_id IS NOT NULL THEN 1 ELSE 0 END as task_closed
        FROM reading_rules r
        INNER JOIN reading_rule_applications rra_global ON r.rule_id = rra_global.rule_id
            AND rra_global.is_open = 1
        LEFT JOIN reading_rule_applications rra_closed ON r.rule_id = rra_closed.rule_id
            AND rra_closed.type = 1
            AND rra_closed.is_open = 0
            AND (
                rra_closed.from_id = #{taskId} 
                OR EXISTS (
                    SELECT 1 FROM breaking_sentences bs 
                    WHERE bs.breaking_sentence_id = rra_closed.from_id AND bs.task_id = #{taskId}
                )
            )
        GROUP BY r.rule_id, r.pattern, r.rule_type, r.rule_value, rra_closed.rule_id
    </select>

    <select id="selectBreakingSentenceRules" resultType="long">
        SELECT DISTINCT rra.rule_id
        FROM reading_rule_applications rra
        WHERE rra.from_id = #{breakingSentenceId}
          AND rra.type = 2
          AND rra.is_open = 1
    </select>

    <select id="selectProcessingBreakingSentencesCount" resultType="int">
        SELECT COUNT(*)
        FROM breaking_sentences
        WHERE synthesis_status = 1
        <if test="excludeBreakingSentenceId != null">
            AND breaking_sentence_id != #{excludeBreakingSentenceId}
        </if>
    </select>

    <select id="selectByFromIdAndType" resultType="map">
        SELECT rule_id as rule_id, is_open as is_open
        FROM reading_rule_applications
        WHERE from_id = #{fromId}
          AND type = #{type}
    </select>

</mapper>



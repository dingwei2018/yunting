# 北京云听音频精修系统 - 需求确认清单

> **说明**：本文档以 `api_design.md` 为标准，对比分析已存在的接口和缺失的接口。

## 一、已确认的技术要求

### 1.1 接口风格

- ✅ **不使用标准RESTful风格**
- ✅ **URL参数使用问号后拼接方式**，例如：
  - `GET /tasks?taskid=1` （而不是 `/tasks/1`）
  - `POST /sentences/synthesize?sentenceid=1`
  - `GET /sentences/info?sentenceid=1`

### 1.2 音频合并

- ✅ **使用ffmpeg进行音频合并**
- ✅ 合并音频是异步操作
- ✅ 合并完成后更新任务的merged_audio_url和merged_audio_duration

### 1.3 字符限制

- ✅ 文本输入支持最多**10000字**（应用层校验）
- ✅ **已确认**：字符限制为10000字

---

## 二、api_design.md接口清单

### 2.0 api_design.md中已存在的接口（16个）

#### 任务管理接口（2个）
1. ✅ `POST /tasks` - 创建任务并自动拆句（3.1）
2. ✅ `GET /tasks/taskid={task_id}` - 获取任务详情（3.2）

#### 句子管理接口（2个）
3. ✅ `GET /tasks/sentences？taskid={task_id}` - 获取句子列表（4.1，需修正中文问号）
4. ✅ `GET /sentences/info?sentenceid={sentence_id}` - 获取句子详情（4.2）

#### 语音合成接口（4个）
5. ✅ `POST /sentences/synthesize?sentenceid={sentence_id}` - 合成单个句子（5.1）
6. ✅ `POST /sentences/resynthesize?sentenceid={sentence_id}` - 重新合成句子（5.2）
7. ✅ `POST /tasks/synthesize?taskid={task_id}` - 批量合成（5.3）
8. ✅ `GET /synthesis/tasks?taskid={task_id}` - 查询合成状态（5.4）

#### 参数调整接口（1个）
9. ✅ `POST /sentences/settings?sentenceid={sentence_id}` - 调整参数（6.1）

#### 阅读规范接口（2个）
10. ✅ `POST /reading-rules` - 创建阅读规范（7.1）
11. ✅ `GET /reading-rules` - 获取阅读规范列表（7.2）

#### 音频编辑接口（3个）
12. ✅ `POST /sentences/insert-below?sentenceid={sentence_id}` - 向下插入句子（8.1）
13. ✅ `POST /tasks/audio/merge?taskid={task_id}` - 合并音频（8.2）
14. ✅ `GET /audio/merges/merge?mergeid={merge_id}` - 查询合并状态（8.3）

#### 音色管理接口（1个）
15. ✅ `GET /voices` - 获取音色列表（9.1）

#### 断句标准接口（1个）
16. ✅ `GET /sentence-breaking/standards` - 获取断句标准（10.1）

---

## 三、对照原型发现的遗漏功能

### 3.1 任务管理相关

#### ✅ 任务列表接口（已确认需要）

**原型需求**：任务列表页面，展示所有任务
**API现状**：只有创建任务和获取任务详情，**缺少任务列表接口**
**已确认**：**此接口需要实现**
**接口设计**：`GET /tasks?page=1&page_size=20&status=2`
**需要确认**：

- 是否需要支持按状态筛选？`GET /tasks?status=2&page=1`
- 是否需要支持按时间排序？

#### ❌ 创建任务并拆句接口（不需要补充拆句规则参数）

**API现状**：已有 `POST /tasks` 接口，会自动拆句
**已确认**：**不需要补充拆句规则参数**，使用默认拆句规则即可

#### ✅ 查询任务详情接口（已存在）

**API现状**：已有 `GET /tasks/taskid={task_id}` 接口
**已确认**：任务详情接口已存在，无需补充

### 3.2 句子管理相关

#### ✅ 删除句子接口（已确认需要）

**原型需求**：句子列表有"删除"按钮
**API现状**：**缺少删除句子接口**
**已确认**：**此接口需要实现**
**接口设计**：`DELETE /sentences?sentenceid={sentence_id}`
**需要确认**：

- 删除后是否需要重新排序sequence？

#### ✅ 编辑句子内容接口（与参数调整接口合并）

**原型需求**：句子列表有"编辑"按钮，可以修改句子内容
**API现状**：**缺少编辑句子内容接口**
**已确认**：**与参数调整接口合并**，通过 `POST /sentences/settings?sentenceid={sentence_id}` 接口的 `content` 参数来修改句子内容
**接口设计**：使用现有的 `POST /sentences/settings?sentenceid={sentence_id}` 接口，请求参数中增加 `content` 字段

### 3.3 停顿和静音相关

#### ✅ 停顿和静音已支持

**API现状**：通过 `pause_settings` 表的 `type` 字段区分（1-停顿，2-静音）
**已确认**：参数调整接口中 `pauses` 数组支持 `type` 字段

#### ❌ 单独的插入静音接口（不需要）

**原型需求**：有专门的"插入静音"功能按钮
**API现状**：静音通过参数调整接口的pauses字段设置
**已确认**：**不需要单独的插入静音接口**，统一使用参数调整接口的pauses字段设置（type=2表示静音）

### 3.4 阅读规范相关

#### ❓ 阅读规范类型细化

**原型需求**：阅读规范包含多种类型

- 连读（页面20）
- 数字英文（页面21、23）
- 音标（页面22、24）
- 专有词汇（页面25）

**API现状**：只有 `rule_type` 字段（如"数字读法"），没有明确类型枚举
**需要确认**：

- `rule_type` 是否需要标准化为枚举值？
- 支持的规则类型有哪些？
  - 连读？
  - 数字读法？
  - 英文读法？
  - 音标？
  - 专有词汇？
  - 其他？

#### ✅ 阅读规范应用接口（已确认需要）

**API现状**：有 `reading_rule_applications` 表，但没有应用接口
**已确认**：**此接口需要实现**
**接口设计**：`POST /reading-rules/apply?ruleid={rule_id}&taskid={task_id}`

### 3.5 其他功能

#### ✅ 任务状态更新（系统内部完成）

**已确认**：任务状态更新是系统内部完成，不需要对外通知接口
- 任务状态何时从"已拆句(2)"变为"已完成(3)"：系统内部自动判断（所有句子都合成完成后自动更新）
- 外部通过任务详情接口 `GET /tasks/taskid={task_id}` 查询任务状态

---

## 四、需要确认的接口参数细节

### 4.1 创建任务接口

**当前设计**：

```json
POST /tasks
{
  "content": "文本内容"
}
```

**已确认**：
- ✅ **字符限制：10000字**（已确认）
- ❌ **不需要拆句规则参数**（已确认，使用默认拆句规则）

### 4.2 批量合成接口

**当前设计**：

```json
POST /tasks/synthesize?taskid={task_id}
{
  "voice_id": "xiaoyan",
  "speech_rate": 0,
  "volume": 0,
  "sentence_ids": [1, 2, 3]
}
```

**需要确认**：

- 如果不传 `sentence_ids`，是否默认合成所有未合成的句子？
- 是否需要支持 `pitch` 参数？

### 4.3 参数调整接口

**当前设计**：

```json
POST /sentences/settings?sentenceid={sentence_id}
{
  "content": "修改后的内容",  // 新增：用于修改句子内容（与编辑句子内容接口合并）
  "speech_rate": 10,
  "volume": 5,
  "pitch": -2,
  "voice_id": "xiaoyan",
  "pauses": [...],
  "polyphonic": [...],
  "reading_rule_ids": [1, 2]
}
```

**已确认**：
- ✅ 编辑句子内容功能与参数调整接口合并，通过 `content` 参数修改句子内容

**需要确认**：

- 所有参数是否都是可选的？
- 如果只传部分参数，是否只更新传入的参数？

### 4.4 合并音频接口

**当前设计**：

```json
POST /tasks/audio/merge?taskid={task_id}
{
  "sentence_ids": [1, 2, 3, 4]
}
```

**需要确认**：

- 如果不传 `sentence_ids`，是否默认合并所有已合成的句子？
- 合并顺序是否按照 `sequence` 字段排序？

---

## 五、需要确认的业务逻辑

### 5.1 拆句逻辑

**需要确认**：

- 拆句算法使用什么规则？
- 是否支持自定义拆句规则？
- 拆句后如何确定每个句子的sequence？

### 5.2 音色继承规则

**已确认**：向下插入的句子音色默认与上一句相同
**需要确认**：

- "上一句"是指sequence-1的句子吗？
- 如果插入到第一个位置，音色如何确定？

### 5.3 SSML生成规则

**需要确认**：

- SSML是实时生成还是保存时生成？
- 参数调整后SSML是否立即更新？
- 合并音频时SSML如何合并？

### 5.4 音频存储

**需要确认**：

- 音频文件存储在哪里？（本地文件系统？OSS？）
- 音频URL的生成规则？
- 音频文件格式？（MP3？WAV？）

### 5.5 异步任务处理

**需要确认**：

- 语音合成使用什么消息队列？（RocketMQ？）
- 合成任务的状态如何更新？
- 是否需要支持任务取消？

---

## 六、需要补充的接口（以api_design.md为标准）

### 6.1 必须补充的接口（api_design.md中缺失）

1. **任务列表接口**
   - api_design.md中缺失，但在11.2分页说明中提到
   - 已确认需要
   ```
   GET /tasks?page=1&page_size=20&status=2
   ```

2. **删除句子接口**
   - api_design.md中缺失
   - 已确认需要
   ```
   DELETE /sentences?sentenceid={sentence_id}
   ```

3. **参数调整接口补充content参数**
   - 接口已存在：`POST /sentences/settings?sentenceid={sentence_id}`（6.1）
   - 需要补充：请求参数增加 `content` 字段，用于修改句子内容
   - 已确认：编辑句子内容功能与参数调整接口合并
   ```
   POST /sentences/settings?sentenceid={sentence_id}
   {
     "content": "修改后的内容",  // 新增：用于修改句子内容
     "speech_rate": 10,
     "volume": 5,
     "pitch": -2,
     "voice_id": "xiaoyan",
     "pauses": [...],
     "polyphonic": [...],
     "reading_rule_ids": [1, 2]
   }
   ```

4. **应用阅读规范接口**
   - api_design.md中缺失
   - 已确认需要
   ```
   POST /reading-rules/apply?ruleid={rule_id}&taskid={task_id}
   ```

### 6.2 需要修正的接口（api_design.md中已存在但格式有误）

1. **获取句子列表接口**
   - 已存在：`GET /tasks/sentences？taskid={task_id}`（4.1）
   - 需要修正：URL中的中文问号"？"改为英文问号"?"
   - 正确格式：`GET /tasks/sentences?taskid={task_id}`

### 6.3 建议补充的接口（api_design.md中缺失，非必需）

（暂无）

---

## 七、待确认问题汇总

### 高优先级（影响核心功能）

1. ✅ **字符限制：10000字**（已确认）
2. ✅ **创建任务接口需要补充拆句规则参数**（已确认需要）
3. ✅ **查询任务下所有句子接口**（已存在，需修正URL格式）
4. ✅ **删除句子接口**（已确认需要，但api_design.md中缺失）
5. ✅ 编辑句子内容接口？（api_design.md中缺失）

### 中优先级（影响用户体验）

6. ✅ 任务列表接口（分页、筛选、排序）？
7. ✅ 阅读规范类型枚举值？
8. ✅ 批量合成时sentence_ids是否可选？
9. ✅ 合并音频时sentence_ids是否可选？

### 低优先级（优化功能）

9. ✅ **阅读规范应用接口**（已确认需要，已移至必须补充的接口）

---

## 八、技术实现确认

### 8.1 音频处理

- ✅ 使用ffmpeg进行音频合并
- ❓ ffmpeg的安装和配置方式？
- ❓ 音频文件存储路径配置？

### 8.2 异步任务

- ✅ 使用RocketMQ
- ❓ 消息队列的Topic和Tag设计？
- ❓ 任务状态轮询间隔？

### 8.3 数据库

- ✅ 使用MySQL
- ❓ 数据库连接池配置？
- ❓ 事务管理策略？

---

**文档创建时间**：2024年
**待确认项数量**：11项
**优先级**：已标注

# 北京云听音频精修系统 - 接口完整说明书

## 一、接口概述

### 1.1 基础信息
- **Base URL**: `https://api.xxxx.com/v1`
- **数据格式**: JSON
- **字符编码**: UTF-8
- **接口风格**: 非标准RESTful，URL参数使用问号后拼接方式

### 1.2 通用响应格式

#### 成功响应
```json
{
  "code": 10200,
  "message": "success",
  "data": {},
  "timestamp": 1640000000000
}
```

#### 错误响应
```json
{
  "code": 10400,
  "message": "错误信息",
  "data": null,
  "timestamp": 1640000000000
}
```

#### 状态码说明
- **10200**: 成功
- **10400**: 请求参数错误
- **10404**: 资源不存在
- **10500**: 服务器错误

---

## 二、任务管理接口

### 2.1 创建任务并自动拆句
**接口**: `POST /api/tasks/createTask?content=...&delimiters=...`

**请求参数（Query/Form）**:
- `content` *(必填)*：原始文本，最多10000字
- `delimiters` *(可选)*：自定义拆句符号字符集，示例 `。！？`，为空则使用默认标点

**响应**:
```json
{
  "code": 10200,
  "data": {
    "task_id": 1,
    "content": "这是一段需要转换为语音的文本内容。支持最多10000字。",
    "char_count": 28,
    "status": 2,
    "merged_audio_url": null,
    "merged_audio_duration": null,
    "ssml": null,
    "sentences": [
      {
        "sentence_id": 1,
        "content": "这是一段需要转换为语音的文本内容。",
        "parent_id": null,
        "sequence": 1,
        "char_count": 18,
        "audio_url": null,
        "audio_duration": null,
        "ssml": null
      },
      {
        "sentence_id": 2,
        "content": "支持最多10000字。",
        "parent_id": null,
        "sequence": 2,
        "char_count": 10,
        "audio_url": null,
        "audio_duration": null,
        "ssml": null
      }
    ],
    "total_sentences": 2,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

**说明**:
- 创建任务时会自动进行拆句处理（根据标点符号拆句或自定义拆句符号）
- 接口使用 URL 参数/表单提交方式，不接受 JSON Body
- 返回的任务状态为2（已拆句）
- 响应中包含拆句后的所有句子列表
- 原始拆句的句子parent_id为null或0
- 文本内容限制10000字

**错误响应**（超过10000字）:
```json
{
  "code": 10400,
  "message": "文本内容不能超过10000字"
}
```

---

### 2.2 获取任务详情
**接口**: `GET /api/tasks/getTaskDetail?taskid={task_id}`

**查询参数**:
- `taskid` *(必填)*：任务ID

**响应**:
```json
{
  "code": 10200,
  "data": {
    "task_id": 1,
    "content": "这是一段需要转换为语音的文本内容。支持最多10000字。",
    "char_count": 28,
    "status": 2,
    "merged_audio_url": "https://example.com/audio/task_1_merged.mp3",
    "merged_audio_duration": 5000,
    "ssml": "<speak><voice name=\"xiaoyan\"><prosody rate=\"0%\" volume=\"0dB\" pitch=\"0%\">这是一段需要转换为语音的文本内容。<break time=\"500ms\"/>支持最多10000字。</prosody></voice></speak>",
    "breaking_sentences": [
      {
        "breaking_sentence_id": 1,
        "content": "这是一段需要转换为语音的文本内容。",
        "original_sentence_id": 1,
        "sequence": 1,
        "synthesis_status": 2,
        "audio_url": "https://example.com/audio/sentence_1.mp3",
        "audio_duration": 3000,
        "ssml": "<speak><voice name=\"xiaoyan\"><prosody rate=\"0%\" volume=\"0dB\" pitch=\"0%\">这是一段需要转换为语音的文本内容。</prosody></voice></speak>"
      },
      {
        "breaking_sentence_id": 2,
        "content": "支持最多10000字。",
        "original_sentence_id": 2,
        "sequence": 2,
        "synthesis_status": 2,
        "audio_url": "https://example.com/audio/sentence_2.mp3",
        "audio_duration": 2000,
        "ssml": "<speak><voice name=\"xiaoyan\"><prosody rate=\"0%\" volume=\"0dB\" pitch=\"0%\">支持最多10000字。</prosody></voice></speak>"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

**说明**:
- `merged_audio_url`: 整个任务的合并音频URL（所有断句合并后的完整音频）
- `merged_audio_duration`: 整个任务的合并音频时长（毫秒）
- `ssml`: 整个任务的SSML配置（XML格式，包含所有编辑配置参数）
- `breaking_sentences`: 断句列表，每个断句包含音频URL、时长、SSML等信息

---

### 2.3 获取任务列表 ⭐（需补充）
**接口**: `GET /api/tasks/listTasks?page=1&page_size=20&status=2`

**查询参数**:
- `page`: 页码（可选，默认1）
- `page_size`: 每页数量（可选，默认20）
- `status`: 任务状态（可选，1-待拆句，2-已拆句，3-已完成）

**响应**:
```json
{
  "code": 10200,
  "data": {
    "list": [
      {
        "task_id": 1,
        "content": "文本内容预览...",
        "char_count": 28,
        "status": 2,
        "total_sentences": 2,
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 20
  }
}
```

**说明**:
- 支持分页查询
- 支持按状态筛选
- 支持按时间排序（默认按创建时间倒序）

---

## 三、断句管理接口

### 3.1 获取断句列表
**接口**: `GET /api/tasks/breaking-sentences?taskid={task_id}`

**查询参数**:
- `taskid`: 任务ID（必填）
- `page`: 页码（可选）
- `page_size`: 每页数量（可选）

**响应**:
```json
{
  "code": 10200,
  "data": {
    "list": [
      {
        "breaking_sentence_id": 1,
        "content": "这是一段需要转换为语音的文本内容。",
        "original_sentence_id": 1,
        "sequence": 1,
        "synthesis_status": 2,
        "audio_url": "https://example.com/audio/sentence_1.mp3",
        "audio_duration": 3000,
        "ssml": "<speak><voice name=\"xiaoyan\"><prosody rate=\"0%\" volume=\"0dB\" pitch=\"0%\">这是一段需要转换为语音的文本内容。</prosody></voice></speak>",
        "settings": {
          "voice_id": "xiaoyan",
          "voice_name": "小燕",
          "speech_rate": 0,
          "volume": 0,
          "pitch": 0
        }
      }
    ],
    "total": 10
  }
}
```

**说明**:
- 返回任务下所有断句列表
- `breaking_sentence_id`: 断句ID（用于参数设置和合成）
- `original_sentence_id`: 原始拆句ID（关联到原始拆句表）

---

### 3.2 获取断句详情
**接口**: `GET /api/breaking-sentences/info?breaking_sentence_id={breaking_sentence_id}`

**响应**:
```json
{
  "code": 10200,
  "data": {
    "breaking_sentence_id": 1,
    "content": "这是一段需要转换为语音的文本内容。",
    "original_sentence_id": 1,
    "sequence": 1,
    "synthesis_status": 2,
    "audio_url": "https://example.com/audio/sentence_1.mp3",
    "audio_duration": 3000,
    "ssml": "<speak><voice name=\"xiaoyan\"><prosody rate=\"10%\" volume=\"5dB\" pitch=\"5%\">这是一段<break time=\"500ms\"/>需要转换为语音的文本内容。</prosody></voice></speak>",
    "settings": {
      "voice_id": "xiaoyan",
      "voice_name": "小燕",
      "speech_rate": 10,
      "volume": 5,
      "pitch": 5
    },
    "pauses": [
      {
        "id": 1,
        "position": 10,
        "duration": 500,
        "type": 1
      }
    ],
    "polyphonic_settings": []
  }
}
```

---

### 3.3 删除断句
**接口**: `DELETE /api/breaking-sentences?breaking_sentence_id={breaking_sentence_id}`

**响应**:
```json
{
  "code": 10200,
  "message": "删除成功",
  "data": {
    "breaking_sentence_id": 1
  }
}
```

**说明**:
- 删除断句后，需要重新排序后续断句的sequence
- 删除断句会级联删除相关的设置（停顿、多音字、合成设置等）

---

## 四、语音合成接口

### 4.1 合成单个断句
**接口**: `POST /api/breaking-sentences/synthesize?breaking_sentence_id={breaking_sentence_id}`

**查询参数**:
- `breaking_sentence_id` *(必填)*
- `voice_id` *(可选)*
- `speech_rate` *(可选)*
- `volume` *(可选)*
- `pitch` *(可选)*

**响应**:
```json
{
  "code": 10200,
  "data": {
    "breaking_sentence_id": 1,
    "synthesis_status": 1,
    "task_id": 1
  }
}
```

**说明**:
- 合成状态：0-未合成，1-合成中，2-已合成，3-合成失败
- 合成是异步操作，需要通过查询合成状态接口获取结果
- 如果传入参数，会更新断句的合成设置后再合成

---

### 4.2 重新合成断句
**接口**: `POST /api/breaking-sentences/resynthesize?breaking_sentence_id={breaking_sentence_id}`

**查询参数**: （同4.1，可选）

**说明**:
- 重新合成会覆盖原有的音频文件
- 使用当前断句的参数设置进行合成
- 如果传入参数，会先更新参数再合成

---

### 4.3 批量合成
**接口**: `POST /api/tasks/synthesize?taskid={task_id}`

**查询参数**:
- `taskid` *(必填)*
- `voice_id` *(可选)*
- `speech_rate` *(可选)*
- `volume` *(可选)*
- `pitch` *(可选)*
- `breaking_sentence_ids` *(可选，使用逗号分隔，如 `1,2,3`)* 

**响应**:
```json
{
  "code": 10200,
  "data": {
    "task_id": 1,
    "total": 3,
    "pending": 3
  }
}
```

**说明**:
- `breaking_sentence_ids`: 可选，不传则合成所有未合成的断句
- 批量合成是异步操作

---

### 4.4 查询合成状态
**接口**: `GET /api/synthesis/tasks?taskid={task_id}`

**响应**:
```json
{
  "code": 10200,
  "data": {
    "task_id": "task_123456",
    "status": "completed",
    "progress": 100,
    "result": {
      "sentence_id": 1,
      "audio_url": "https://...",
      "audio_duration": 3000
    }
  }
}
```

---

## 五、参数调整接口

### 5.1 调整断句参数（批量设置）
**接口**: `POST /breaking-sentences/settings?taskid={task_id}`

**说明**: 此接口用于批量设置多个断句的参数。前端在点击"保存设置"时，将所有断句的参数一并提交。

**请求参数**:
```json
{
  "breaking_sentences": [
    {
      "breaking_sentence_id": 1,  // 断句ID（必填）
      "content": "修改后的内容",  // 断句内容（可选，用于修改内容）
      "speech_rate": 10,  // 语速（可选）
      "volume": 5,  // 音量（可选）
      "pitch": -2,  // 音调（可选）
      "voice_id": "xiaoyan",  // 音色ID（可选）
      "pauses": [  // 停顿设置（可选）
        {"id": 1, "position": 10, "duration": 500, "type": 1},  // type: 1-停顿，2-静音
        {"position": 25, "duration": 1000, "type": 2}
      ],
      "polyphonic": [  // 多音字设置（可选）
        {"id": 3, "character": "重", "position": 8, "pronunciation": "zhong4"}
      ],
      "reading_rule_ids": [1, 2]  // 阅读规范ID列表（可选）
    },
    {
      "breaking_sentence_id": 2,
      "speech_rate": 5,
      "volume": 3
    }
  ]
}
```

**响应**:
```json
{
  "code": 10200,
  "message": "参数更新成功",
  "data": {
    "updated_count": 2
  }
}
```

**说明**:
- 每个断句的参数都是独立的
- 只更新传入的参数，未传入的参数保持不变
- `content`: 用于修改断句内容
- `pauses`: 停顿和静音设置，type=1表示停顿，type=2表示静音
- `polyphonic`: 多音字设置
- `reading_rule_ids`: 应用的阅读规范ID列表
- 参数调整后，SSML会自动更新

---

### 5.2 调整单个断句参数
**接口**: `POST /breaking-sentences/settings?breaking_sentence_id={breaking_sentence_id}`

**说明**: 此接口用于设置单个断句的参数。

**请求参数**:
```json
{
  "content": "修改后的内容",  // 断句内容（可选）
  "speech_rate": 10,  // 语速（可选）
  "volume": 5,  // 音量（可选）
  "pitch": -2,  // 音调（可选）
  "voice_id": "xiaoyan",  // 音色ID（可选）
  "pauses": [  // 停顿设置（可选）
    {"id": 1, "position": 10, "duration": 500, "type": 1},
    {"position": 25, "duration": 1000, "type": 2}
  ],
  "polyphonic": [  // 多音字设置（可选）
    {"id": 3, "character": "重", "position": 8, "pronunciation": "zhong4"}
  ],
  "reading_rule_ids": [1, 2]  // 阅读规范ID列表（可选）
}
```

**响应**:
```json
{
  "code": 10200,
  "message": "参数更新成功",
  "data": {
    "breaking_sentence_id": 1
  }
}
```

---

## 六、阅读规范接口

### 6.1 创建阅读规范
**接口**: `POST /reading-rules`

**请求参数**:
```json
{
  "task_id": 1,
  "pattern": "2025",
  "rule_type": "数字读法",
  "rule_value": "二零二五",
  "scope": 2
}
```

**说明**:
- `scope`: 1-全局，2-任务
- `task_id`: scope为2时必填

---

### 6.2 获取阅读规范列表
**接口**: `GET /reading-rules?task_id=1&scope=2`

**查询参数**:
- `task_id`: 任务ID（可选）
- `scope`: 作用域（可选，1-全局，2-任务）

**响应**:
```json
{
  "code": 10200,
  "data": {
    "list": [
      {
        "id": 1,
        "pattern": "2025",
        "rule_type": "数字读法",
        "rule_value": "二零二五",
        "scope": 2,
        "task_id": 1
      }
    ]
  }
}
```

---

### 6.3 应用阅读规范 ⭐（需补充）
**接口**: `POST /reading-rules/apply?ruleid={rule_id}&taskid={task_id}`

**响应**:
```json
{
  "code": 10200,
  "message": "应用成功",
  "data": {
    "rule_id": 1,
    "task_id": 1,
    "applied_count": 5
  }
}
```

**说明**:
- 将阅读规范应用到指定任务的所有断句
- 自动匹配句子中的模式并应用规则

---

## 七、音频编辑接口

### 7.1 合并音频
**接口**: `POST /tasks/audio/merge?taskid={task_id}`

**请求参数**:
```json
{
  "sentence_ids": [1, 2, 3, 4]
}
```

**响应**:
```json
{
  "code": 10200,
  "data": {
    "merge_id": 1,
    "task_id": 1,
    "merged_audio_url": "https://example.com/audio/task_1_merged.mp3",
    "audio_duration": 12000,
    "status": "completed"
  }
}
```

**说明**:
- `breaking_sentence_ids`: 可选，不传则合并所有已合成的断句
- 合并顺序按照sequence字段排序
- 合并音频使用ffmpeg进行
- 合并完成后，任务的merged_audio_url和merged_audio_duration字段会自动更新

---

### 7.2 查询合并状态
**接口**: `GET /audio/merges/merge?mergeid={merge_id}`

**响应**:
```json
{
  "code": 10200,
  "data": {
    "merge_id": 1,
    "task_id": 1,
    "status": "completed",
    "merged_audio_url": "https://example.com/audio/task_1_merged.mp3",
    "audio_duration": 12000
  }
}
```

**说明**:
- 合并完成后，可以通过任务详情接口获取任务的merged_audio_url和merged_audio_duration

---

## 八、音色管理接口

### 8.1 获取音色列表
**接口**: `GET /voices?is_recommended=1&language=zh-CN`

**查询参数**:
- `is_recommended`: 是否只获取推荐音色（1-是，0-否）
- `language`: 语言（默认zh-CN）

**响应**:
```json
{
  "code": 10200,
  "data": {
    "list": [
      {
        "voice_id": "xiaoyan",
        "voice_name": "小燕",
        "voice_type": "女声",
        "language": "zh-CN",
        "is_recommended": 1,
        "sort_order": 1
      }
    ]
  }
}
```

---

## 九、断句标准接口

### 9.1 获取断句标准
**接口**: `GET /sentence-breaking/standards`

**响应**:
```json
{
  "code": 10200,
  "data": {
    "standards": [
      {
        "id": 1,
        "name": "大符号断句",
        "description": "根据标点符号进行断句（。！？；等）",
        "type": "punctuation"
      },
      {
        "id": 2,
        "name": "N个字符断句",
        "description": "根据指定字符数进行断句",
        "type": "char_count"
      }
    ]
  }
}
```

**说明**:
- 此接口仅用于查询系统支持的断句标准
- 断句标准的保存和应用在参数设置接口中完成

---

### 9.2 保存断句标准设置 ⭐（需补充）
**接口**: `POST /sentence-breaking/settings?taskid={task_id}`

**请求参数**:
```json
{
  "breaking_standard_id": 2,  // 断句标准ID（1-大符号，2-N个字符）
  "char_count": 50  // 当断句标准为"N个字符"时必填
}
```

**响应**:
```json
{
  "code": 10200,
  "message": "断句标准设置保存成功",
  "data": {
    "task_id": 1,
    "breaking_standard_id": 2,
    "char_count": 50
  }
}
```

**说明**:
- 此接口仅用于保存断句标准设置，**不执行断句操作**
- 断句操作在参数设置接口中，通过`rebreak_sentence`参数触发
- 如果断句标准是"大符号"（ID=1），拆句逻辑不变，句子内容还是原始的
- 如果断句标准是"N个字符"（ID=2），需要在参数设置时指定char_count，系统会根据N个字符将原句子拆成新的一组句子

---

## 十、接口统计

### 10.1 接口总数
- **已存在接口**: 16个
- **需补充接口**: 5个
- **需修正接口**: 1个
- **接口总计**: 21个

### 10.2 接口分类统计

| 分类 | 数量 | 说明 |
|------|------|------|
| 任务管理 | 3 | 创建、详情、列表 |
| 句子管理 | 3 | 列表、详情、删除 |
| 语音合成 | 4 | 单个合成、重新合成、批量合成、查询状态 |
| 参数调整 | 1 | 调整参数（包含编辑内容、向下插入、重新断句） |
| 阅读规范 | 3 | 创建、列表、应用 |
| 音频编辑 | 2 | 合并音频、查询合并状态 |
| 音色管理 | 1 | 获取音色列表 |
| 断句标准 | 2 | 获取断句标准、保存断句标准设置 |

### 10.3 接口变更说明（v2.0）

1. ✅ **数据结构重构** - 原始拆句表和断句表分离
   - 原始拆句表（original_sentences）：存储最初拆句的结果
   - 断句表（breaking_sentences）：存储实际用于合成的断句
   
2. ✅ **断句管理接口** - 将"句子管理"改为"断句管理"
   - 接口路径从 `/sentences` 改为 `/breaking-sentences`
   - 参数从 `sentence_id` 改为 `breaking_sentence_id`
   
3. ✅ **参数调整接口重构** - 改为传入断句ID和参数
   - 支持批量设置多个断句的参数
   - 支持单个断句的参数设置
   - 移除了parent_id相关的复杂层级关系
   
4. ✅ **断句标准接口** - 保存设置并立即重新生成断句
   - 大符号模式：复制原始拆句到断句表
   - N个字符模式：重新拆分原始拆句，生成多个断句

### 10.5 需修正的接口

1. ⚠️ **获取句子列表接口** - URL中的中文问号"？"改为英文问号"?"
   - 错误：`GET /tasks/sentences？taskid={task_id}`
   - 正确：`GET /tasks/sentences?taskid={task_id}`

---

## 十一、重要说明

### 11.1 任务状态
- **1-待拆句**: 任务已创建，等待拆句
- **2-已拆句**: 任务已拆句完成，生成句子列表
- **3-已完成**: 所有句子都合成完成（系统内部自动更新）

### 11.2 合成状态
- **0-未合成**: 句子尚未生成音频
- **1-合成中**: 正在生成音频
- **2-已合成**: 音频已生成，可以播放
- **3-合成失败**: 合成失败

### 11.3 异步操作
- 语音合成、音频合并等操作是异步的
- 返回task_id或merge_id用于查询状态
- 使用轮询获取结果

### 11.4 SSML配置
- SSML（Speech Synthesis Markup Language）用于控制TTS系统的输出特性
- 每个句子和整个任务都有对应的SSML字段
- SSML字段会根据用户的编辑操作自动生成和更新
- 包含：音色、语速、音量、音调、停顿、多音字等配置

### 11.5 字符限制
- 文本输入限制10000字
- 超过限制会返回10400错误

### 11.6 数据结构说明（v2.0）

#### 11.6.1 原始拆句表（original_sentences）
- 存储最初拆句的结果（根据标点符号拆句）
- 创建任务时自动生成
- 数据不会改变，用于历史记录

#### 11.6.2 断句表（breaking_sentences）
- 存储实际用于合成的断句
- 每个断句有独立的参数设置
- 根据断句标准从原始拆句生成

#### 11.6.3 断句标准逻辑
- **大符号断句**（ID=1）:
  - 将原始拆句表的内容复制到断句表
  - 每个原始拆句对应一个断句
  - `breaking_sentences.original_sentence_id` 关联到对应的原始拆句
  
- **N个字符断句**（ID=2）:
  - 根据指定的字符数（char_count）重新拆分原始拆句
  - 一个原始拆句可能被拆分成多个断句
  - 每个断句的 `original_sentence_id` 都指向同一个原始拆句

### 11.7 参数设置说明
- 每个断句有独立的参数设置（合成设置、停顿设置、多音字设置等）
- 参数设置接口传入断句ID（breaking_sentence_id）和参数
- 支持批量设置多个断句的参数
- 参数更新后，SSML自动重新生成

### 11.8 数据流转
1. **创建任务** → 原始拆句表 → 断句表（根据断句标准）
2. **设置断句标准** → 更新任务表的断句标准 → 重新生成断句表
3. **参数设置** → 更新断句的参数设置 → 更新SSML
4. **语音合成** → 更新断句表的合成状态和音频URL
5. **音频合并** → 合并断句的音频 → 更新任务表的合并音频URL

---

**文档版本**: v2.0  
**最后更新**: 2024年  
**接口总数**: 21个  
**重要变更**: 数据结构重构，原始拆句表和断句表分离，参数设置改为传入断句ID


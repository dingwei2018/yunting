# 北京云听音频精修系统 - 开发任务拆解

## 一、项目概述

### 1.1 技术栈
- **后端框架**: Spring Boot 2.x / 3.x
- **ORM框架**: MyBatis
- **消息队列**: RocketMQ
- **数据库**: MySQL 8.0+
- **对象存储**: 华为云OBS
- **第三方服务**: 华为云MetaStudio TTS（WebSocket）
- **音频处理**: FFmpeg

### 1.2 开发阶段规划

本项目按照功能模块和依赖关系，分为以下5个阶段进行开发：

---

## 二、开发阶段详细拆解

### 第一阶段：基础框架搭建（预计3-5天）

#### 1.1 项目初始化
- [ ] 创建Spring Boot项目
- [ ] 配置Maven/Gradle依赖
- [ ] 配置数据库连接（MySQL）
- [ ] 配置MyBatis
- [ ] 配置RocketMQ连接
- [ ] 配置日志（Logback/SLF4J）
- [ ] 统一响应格式封装（ResponseUtil）
- [ ] 全局异常处理（ExceptionHandler）
- [ ] 参数校验工具（ValidationUtil）

#### 1.2 数据库初始化
- [ ] 创建数据库表结构（9张表）
  - tasks（任务表）
  - sentences（句子表，包含parent_id字段）
  - synthesis_settings（合成设置表）
  - pause_settings（停顿设置表）
  - polyphonic_settings（多音字设置表）
  - reading_rules（阅读规范表）
  - reading_rule_applications（阅读规范应用表）
  - audio_merges（音频合并记录表）
  - voice_configs（音色配置表）
- [ ] 创建索引（parent_id索引等）
- [ ] 初始化基础数据（断句标准、默认音色等）

#### 1.3 配置管理
- [ ] 华为云MetaStudio配置（Region、Project ID、认证信息）
- [ ] 华为云OBS配置（Endpoint、Access Key ID、Secret Access Key、Bucket Name）
- [ ] RocketMQ配置（NameServer、Topic、Consumer Group）
- [ ] FFmpeg路径配置
- [ ] 文件上传大小限制配置

**交付物**:
- 可启动的Spring Boot项目
- 数据库表结构
- 基础配置管理

---

### 第二阶段：核心服务模块开发（预计10-15天）

#### 2.1 认证服务模块（AuthenticationService）
- [ ] 华为云IAM Token获取
- [ ] Token缓存机制（Redis或内存缓存）
- [ ] Token自动刷新

#### 2.2 华为云OSS客户端模块（HuaweiCloudOBSService）
- [ ] 集成华为云OBS Java SDK
- [ ] 文件上传功能
- [ ] 文件删除功能
- [ ] URL生成功能
- [ ] 文件存在性检查

#### 2.3 文本拆句服务模块（SentenceBreakingService）
- [ ] 大符号断句逻辑（标点符号：。！？；等）
- [ ] N个字符断句逻辑
- [ ] 拆句结果处理（生成句子记录）

#### 2.4 任务管理服务模块（TaskService）
- [ ] 创建任务接口（POST /tasks）
  - 接收文本内容（10000字限制）
  - 调用拆句服务
  - 创建任务和句子记录
- [ ] 获取任务详情接口（GET /tasks/taskid={task_id}）
- [ ] 获取任务列表接口（GET /tasks?page=1&page_size=20&status=2）
- [ ] 任务状态管理（自动更新）

#### 2.5 句子管理服务模块（SentenceService）
- [ ] 获取句子列表接口（GET /tasks/sentences?taskid={task_id}）
- [ ] 获取句子详情接口（GET /sentences/info?sentenceid={sentence_id}）
- [ ] 删除句子接口（DELETE /sentences?sentenceid={sentence_id}）
- [ ] 句子层级关系管理（parent_id）
- [ ] 句子序列号管理（sequence）

**交付物**:
- 任务和句子管理功能完整可用
- 基础数据CRUD功能

---

### 第三阶段：语音合成与参数调整（预计12-18天）

#### 3.1 SSML服务模块（SSMLService）
- [ ] SSML生成逻辑
  - 音色配置（voice）
  - 语速配置（prosody rate）
  - 音量配置（prosody volume）
  - 音调配置（prosody pitch）
  - 停顿配置（break）
  - 多音字配置
- [ ] SSML更新逻辑（根据参数调整）
- [ ] 华为云SSML格式适配

#### 3.2 华为云TTS客户端模块（HuaweiCloudTTSClient）
- [ ] WebSocket连接管理
- [ ] SSML发送和接收
- [ ] 音频数据接收（base64解码）
- [ ] 流式数据处理
- [ ] 错误处理和重连机制

#### 3.3 语音合成服务模块（SynthesisService）
- [ ] 单个句子合成接口（POST /sentences/synthesize?sentenceid={sentence_id}）
- [ ] 重新合成接口（POST /sentences/resynthesize?sentenceid={sentence_id}）
- [ ] 批量合成接口（POST /tasks/synthesize?taskid={task_id}）
- [ ] 查询合成状态接口（GET /synthesis/tasks?taskid={task_id}）
- [ ] 异步合成任务处理（RocketMQ消费者）
- [ ] 合成状态更新

#### 3.4 音频存储服务模块（AudioStorageService）
- [ ] 音频文件上传到OBS
- [ ] 音频URL生成
- [ ] 音频时长计算（FFmpeg）
- [ ] 音频文件删除

#### 3.5 参数调整服务模块（ParameterAdjustmentService）
- [ ] 调整参数接口（POST /sentences/settings?sentenceid={sentence_id}）
  - 编辑句子内容（content）
  - 音色、语速、音量、音调调整
  - 停顿设置（pauses）
  - 多音字设置（polyphonic）
  - 阅读规范应用（reading_rule_ids）
  - **向下插入句子**（insert_sentences）
  - **重新断句**（rebreak_sentence）
- [ ] SSML自动更新
- [ ] 句子层级关系处理（parent_id）

**交付物**:
- 语音合成功能完整可用
- 参数调整功能完整可用
- 音频存储功能完整可用

---

### 第四阶段：高级功能开发（预计8-12天）

#### 4.1 阅读规范服务模块（ReadingRuleService）
- [ ] 创建阅读规范接口（POST /reading-rules）
- [ ] 获取阅读规范列表接口（GET /reading-rules?task_id=1&scope=2）
- [ ] 应用阅读规范接口（POST /reading-rules/apply?ruleid={rule_id}&taskid={task_id}）
- [ ] 阅读规范匹配逻辑（模式匹配）
- [ ] 阅读规范应用到句子（自动更新SSML）

#### 4.2 音频编辑服务模块（AudioEditingService）
- [ ] 合并音频接口（POST /tasks/audio/merge?taskid={task_id}）
- [ ] 查询合并状态接口（GET /audio/merges/merge?mergeid={merge_id}）
- [ ] FFmpeg集成（音频合并）
- [ ] 异步合并任务处理（RocketMQ消费者）
- [ ] 合并音频上传到OBS

#### 4.3 音色管理服务模块（VoiceService）
- [ ] 获取音色列表接口（GET /voices?is_recommended=1&language=zh-CN）
- [ ] 音色数据管理（从华为云获取或本地配置）

#### 4.4 断句标准服务模块（SentenceBreakingService扩展）
- [ ] 获取断句标准接口（GET /sentence-breaking/standards）
- [ ] 保存断句标准设置接口（POST /sentence-breaking/settings?taskid={task_id}）
- [ ] 重新断句逻辑（基于N个字符）
- [ ] 句子层级关系处理（parent_id）

**交付物**:
- 阅读规范功能完整可用
- 音频合并功能完整可用
- 音色管理功能完整可用
- 断句标准功能完整可用

---

### 第五阶段：优化与完善（预计5-8天）

#### 5.1 消息队列服务模块（RocketMQService）
- [ ] 消息发送封装
- [ ] 批量合成消费者
- [ ] 音频合并消费者
- [ ] 消息重试机制
- [ ] 消息幂等性处理

#### 5.2 异常处理和重试机制
- [ ] 华为云TTS调用异常处理
- [ ] OBS上传异常处理
- [ ] FFmpeg执行异常处理
- [ ] 数据库操作异常处理
- [ ] 重试机制实现

#### 5.3 性能优化
- [ ] 数据库查询优化（索引、分页）
- [ ] 缓存机制（Token、音色列表等）
- [ ] 异步处理优化
- [ ] 连接池优化

#### 5.4 日志和监控
- [ ] 关键操作日志记录
- [ ] 错误日志记录
- [ ] 性能监控（可选）

#### 5.5 单元测试和集成测试
- [ ] Service层单元测试
- [ ] Controller层集成测试
- [ ] 接口测试脚本完善

**交付物**:
- 系统稳定可用
- 测试覆盖完整
- 性能优化完成

---

## 三、开发优先级

### 高优先级（核心功能）
1. **第一阶段**：基础框架搭建
2. **第二阶段**：核心服务模块（任务管理、句子管理）
3. **第三阶段**：语音合成与参数调整

### 中优先级（重要功能）
4. **第四阶段**：高级功能（阅读规范、音频合并）

### 低优先级（优化完善）
5. **第五阶段**：优化与完善

---

## 四、接口开发顺序建议

### 第一批接口（基础功能）
1. POST /tasks - 创建任务并自动拆句
2. GET /tasks/taskid={task_id} - 获取任务详情
3. GET /tasks?page=1&page_size=20 - 获取任务列表
4. GET /tasks/sentences?taskid={task_id} - 获取句子列表
5. GET /sentences/info?sentenceid={sentence_id} - 获取句子详情

### 第二批接口（核心功能）
6. POST /sentences/synthesize?sentenceid={sentence_id} - 合成单个句子
7. GET /synthesis/tasks?taskid={task_id} - 查询合成状态
8. POST /sentences/settings?sentenceid={sentence_id} - 调整参数（基础参数）
9. GET /voices?is_recommended=1 - 获取音色列表

### 第三批接口（高级功能）
10. POST /sentences/settings - 调整参数（完整功能：插入句子、重新断句）
11. POST /tasks/synthesize?taskid={task_id} - 批量合成
12. POST /tasks/audio/merge?taskid={task_id} - 合并音频
13. POST /reading-rules - 创建阅读规范
14. POST /reading-rules/apply - 应用阅读规范
15. POST /sentence-breaking/settings - 保存断句标准设置

### 第四批接口（完善功能）
16. POST /sentences/resynthesize - 重新合成
17. DELETE /sentences?sentenceid={sentence_id} - 删除句子
18. GET /reading-rules - 获取阅读规范列表
19. GET /sentence-breaking/standards - 获取断句标准
20. GET /audio/merges/merge?mergeid={merge_id} - 查询合并状态

---

## 五、技术难点和注意事项

### 5.1 技术难点
1. **华为云MetaStudio WebSocket集成**
   - WebSocket连接管理
   - 流式数据处理
   - 错误处理和重连

2. **句子层级关系管理**
   - parent_id逻辑处理
   - 重新断句时的句子关系维护
   - 插入句子时的序列号调整

3. **SSML自动生成和更新**
   - 根据用户编辑自动生成SSML
   - 华为云SSML格式适配
   - SSML更新时机

4. **异步任务处理**
   - RocketMQ消息队列
   - 任务状态管理
   - 轮询机制

5. **音频处理**
   - FFmpeg集成
   - 音频合并逻辑
   - 音频时长计算

### 5.2 注意事项
1. **字符限制**：文本输入限制10000字
2. **URL参数格式**：使用问号后拼接方式（非标准RESTful）
3. **异步操作**：语音合成、音频合并是异步的，需要轮询查询状态
4. **句子层级**：parent_id逻辑要正确处理
5. **断句标准**：保存设置和实际断句操作是分开的
6. **华为云配置**：需要正确配置OBS和MetaStudio的认证信息

---

## 六、测试计划

### 6.1 单元测试
- Service层核心逻辑测试
- 工具类测试

### 6.2 集成测试
- Controller层接口测试
- 数据库操作测试
- 第三方服务集成测试（Mock）

### 6.3 接口测试
- 使用Postman进行接口测试
- 使用Python脚本进行自动化测试
- 测试所有21个接口

### 6.4 端到端测试
- 完整业务流程测试
- 异常场景测试

---

## 七、开发时间估算

| 阶段 | 预计时间 | 说明 |
|------|---------|------|
| 第一阶段：基础框架搭建 | 3-5天 | 项目初始化、数据库、配置 |
| 第二阶段：核心服务模块 | 10-15天 | 任务管理、句子管理 |
| 第三阶段：语音合成与参数调整 | 12-18天 | TTS集成、参数调整 |
| 第四阶段：高级功能开发 | 8-12天 | 阅读规范、音频合并 |
| 第五阶段：优化与完善 | 5-8天 | 优化、测试、完善 |
| **总计** | **38-58天** | 约2-3个月 |

---

## 八、下一步行动

1. ✅ 创建开发任务拆解文档（本文档）
2. ⏳ 创建接口测试脚本（Python）
3. ⏳ 创建Postman Collection配置文件
4. ⏳ 开始第一阶段开发

---

**文档版本**: v1.0  
**创建时间**: 2024年  
**最后更新**: 2024年

